<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é­”æ³•å­¦é™¢ Â· Wizard Academy</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Lato:wght@300;400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet" onerror="console.log('fonts unavailable, using fallback')">
<style>
  /* Fallback font stack if Google Fonts unavailable */
  @font-face { font-family: 'Cinzel'; src: local('Georgia'), local('Times New Roman'); }
</style>
<style>
:root {
  --gold: #f5c518;
  --gold-dark: #c9a227;
  --gold-light: #ffe566;
  --scarlet: #7f0000;
  --scarlet-light: #ae1212;
  --parchment: #f4e4bc;
  --parchment-dark: #e8d5a3;
  --ink: #1a0a00;
  --ink-light: #3d1f00;
  --midnight: #0a0a1a;
  --midnight-blue: #0d1b4b;
  --deep-purple: #1a0a2e;
  --magic-blue: #4a90d9;
  --magic-glow: #7ec8f7;
  --green-slytherin: #1a472a;
  --silver: #c0c0c0;
  --hufflepuff-yellow: #f0c040;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Lato', 'ZCOOL XiaoWei', sans-serif;
  background: var(--midnight);
  color: var(--parchment);
  min-height: 100vh;
  overflow-x: hidden;
  cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath d='M7 2l1 4-3 2 3 2-1 4 4-2 4 2-1-4 3-2-3-2 1-4z' fill='%23f5c518' stroke='%23c9a227' stroke-width='1'/%3E%3C/svg%3E") 12 12, auto;
}

/* ===== STARS BACKGROUND ===== */
.stars-bg {
  position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none;
}
.star {
  position: absolute; background: white; border-radius: 50%;
  animation: twinkle var(--dur, 3s) ease-in-out infinite var(--delay, 0s);
}
@keyframes twinkle {
  0%,100% { opacity: 0.1; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.5); }
}

/* Floating particles */
.particle {
  position: fixed; pointer-events: none; z-index: 0;
  animation: floatUp var(--dur, 8s) ease-in-out infinite var(--delay, 0s);
  font-size: var(--size, 14px);
  opacity: 0;
}
@keyframes floatUp {
  0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
  10% { opacity: 0.7; }
  90% { opacity: 0.7; }
  100% { transform: translateY(-20vh) rotate(360deg); opacity: 0; }
}

/* ===== SCREENS ===== */
.screen { display: none; position: relative; z-index: 1; min-height: 100vh; }
.screen.active { display: block; }

/* ===== CHARACTER SELECT ===== */
#screen-character {
  display: none;
  background: radial-gradient(ellipse at center, #1a0d4a 0%, #0a0a1a 70%);
  align-items: center; justify-content: center; flex-direction: column;
  padding: 40px 20px;
}
#screen-character.active { display: flex; }

.hogwarts-crest {
  font-size: 80px;
  animation: floatCrest 4s ease-in-out infinite;
  filter: drop-shadow(0 0 20px #f5c518);
  margin-bottom: 10px;
}
@keyframes floatCrest {
  0%,100% { transform: translateY(0) rotate(-2deg); }
  50% { transform: translateY(-15px) rotate(2deg); }
}

.title-main {
  font-family: 'Cinzel', serif;
  font-size: clamp(24px, 5vw, 48px);
  font-weight: 800;
  color: var(--gold);
  text-shadow: 0 0 30px rgba(245,197,24,0.8), 0 0 60px rgba(245,197,24,0.4);
  text-align: center;
  letter-spacing: 3px;
  animation: glowPulse 3s ease-in-out infinite;
}
.title-sub {
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: clamp(16px, 3vw, 24px);
  color: var(--parchment);
  text-align: center;
  margin-top: 8px;
  opacity: 0.9;
}
@keyframes glowPulse {
  0%,100% { text-shadow: 0 0 20px rgba(245,197,24,0.6), 0 0 40px rgba(245,197,24,0.3); }
  50% { text-shadow: 0 0 40px rgba(245,197,24,1), 0 0 80px rgba(245,197,24,0.6), 0 0 120px rgba(245,197,24,0.3); }
}

.character-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 20px;
  max-width: 900px;
  width: 100%;
  margin-top: 40px;
}

.character-card {
  background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
  border: 2px solid rgba(245,197,24,0.3);
  border-radius: 16px;
  padding: 24px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
  backdrop-filter: blur(10px);
}
.character-card::before {
  content: '';
  position: absolute; inset: 0;
  background: var(--house-color, rgba(245,197,24,0.1));
  opacity: 0; transition: opacity 0.3s;
  border-radius: 14px;
}
.character-card:hover {
  transform: translateY(-12px) scale(1.05);
  border-color: var(--gold);
  box-shadow: 0 20px 60px rgba(245,197,24,0.3), 0 0 40px var(--house-glow, rgba(245,197,24,0.2));
}
.character-card:hover::before { opacity: 1; }

.char-avatar {
  font-size: 64px;
  display: block;
  margin-bottom: 12px;
  animation: charFloat 3s ease-in-out infinite;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
}
@keyframes charFloat {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
.char-name-en { font-family: 'Cinzel', serif; font-size: 14px; color: var(--gold); font-weight: 600; }
.char-name-zh { font-size: 13px; color: var(--parchment); opacity: 0.8; margin-top: 4px; }
.char-house { font-size: 11px; margin-top: 6px; padding: 3px 10px; border-radius: 20px; display: inline-block; }
.char-trait { font-size: 11px; color: var(--parchment); opacity: 0.6; margin-top: 6px; font-style: italic; }

/* House colors */
.house-gryffindor { --house-color: rgba(174,18,18,0.15); --house-glow: rgba(174,18,18,0.3); }
.house-gryffindor .char-house { background: rgba(174,18,18,0.3); color: #ff9999; border: 1px solid rgba(174,18,18,0.5); }
.house-hufflepuff { --house-color: rgba(240,192,64,0.15); --house-glow: rgba(240,192,64,0.3); }
.house-hufflepuff .char-house { background: rgba(240,192,64,0.2); color: #ffe066; border: 1px solid rgba(240,192,64,0.5); }
.house-ravenclaw { --house-color: rgba(74,144,217,0.15); --house-glow: rgba(74,144,217,0.3); }
.house-ravenclaw .char-house { background: rgba(74,144,217,0.2); color: #a0d0ff; border: 1px solid rgba(74,144,217,0.5); }
.house-slytherin { --house-color: rgba(26,71,42,0.3); --house-glow: rgba(26,71,42,0.5); }
.house-slytherin .char-house { background: rgba(26,71,42,0.4); color: #80d080; border: 1px solid rgba(26,71,42,0.7); }

/* ===== MAIN APP ===== */
#screen-main { background: radial-gradient(ellipse at 20% 0%, #1a0d4a 0%, #0a0a1a 50%, #0d0a05 100%); }

/* Header */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: linear-gradient(to bottom, rgba(10,10,26,0.98) 0%, rgba(10,10,26,0.9) 100%);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(245,197,24,0.2);
  padding: 12px 20px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}

.header-left { display: flex; align-items: center; gap: 12px; }
.player-avatar-sm { font-size: 32px; cursor: pointer; transition: transform 0.3s; }
.player-avatar-sm:hover { transform: scale(1.2) rotate(10deg); }
.player-info .player-name { font-family: 'Cinzel', serif; font-size: 14px; color: var(--gold); }
.player-info .player-house { font-size: 11px; opacity: 0.7; }

.header-center {
  font-family: 'Cinzel', serif;
  font-size: clamp(14px, 3vw, 20px);
  color: var(--gold);
  text-align: center;
  flex: 1;
}

.header-right { display: flex; align-items: center; gap: 16px; }

/* Points display */
.points-display {
  display: flex; align-items: center; gap: 6px;
  background: rgba(245,197,24,0.1);
  border: 1px solid rgba(245,197,24,0.3);
  border-radius: 20px;
  padding: 6px 14px;
  font-family: 'Cinzel', serif;
  font-size: 14px;
  color: var(--gold);
}
.points-star { font-size: 16px; animation: spin 4s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Day badge */
.day-badge {
  background: linear-gradient(135deg, var(--scarlet-light), var(--scarlet));
  border: 1px solid rgba(245,197,24,0.4);
  border-radius: 12px;
  padding: 4px 12px;
  font-size: 12px;
  font-family: 'Cinzel', serif;
  color: var(--gold);
}

/* ===== NAV ===== */
.app-nav {
  display: flex; gap: 4px;
  padding: 8px 20px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid rgba(245,197,24,0.1);
  overflow-x: auto;
  scrollbar-width: none;
}
.app-nav::-webkit-scrollbar { display: none; }
.nav-btn {
  flex-shrink: 0;
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid transparent;
  background: transparent;
  color: rgba(244,228,188,0.6);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Lato', sans-serif;
  white-space: nowrap;
  display: flex; align-items: center; gap: 6px;
}
.nav-btn:hover { color: var(--parchment); background: rgba(245,197,24,0.1); }
.nav-btn.active {
  background: linear-gradient(135deg, rgba(245,197,24,0.25), rgba(245,197,24,0.1));
  border-color: rgba(245,197,24,0.5);
  color: var(--gold);
}

/* ===== CONTENT PANELS ===== */
.panel { display: none; padding: 20px; max-width: 900px; margin: 0 auto; }
.panel.active { display: block; animation: fadeInUp 0.5s ease; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== STORY PANEL ===== */
.story-date-header {
  text-align: center;
  margin-bottom: 24px;
}
.story-date {
  font-family: 'Cinzel', serif;
  font-size: 12px;
  color: var(--gold);
  opacity: 0.7;
  letter-spacing: 2px;
  text-transform: uppercase;
}
.story-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(20px, 4vw, 32px);
  font-weight: 800;
  color: var(--gold);
  margin-top: 8px;
  line-height: 1.3;
  text-shadow: 0 0 20px rgba(245,197,24,0.5);
}
.story-subtitle {
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: clamp(16px, 3vw, 22px);
  color: var(--parchment);
  margin-top: 6px;
  opacity: 0.9;
}
.story-subject-tags {
  display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;
  margin-top: 12px;
}
.subject-tag {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.tag-math { background: rgba(74,144,217,0.2); color: #7ec8f7; border: 1px solid rgba(74,144,217,0.4); }
.tag-science { background: rgba(50,180,80,0.2); color: #80e0a0; border: 1px solid rgba(50,180,80,0.4); }
.tag-social { background: rgba(240,120,60,0.2); color: #f0a080; border: 1px solid rgba(240,120,60,0.4); }
.tag-english { background: rgba(180,80,200,0.2); color: #d0a0e8; border: 1px solid rgba(180,80,200,0.4); }

/* Story illustration */
.story-illustration {
  width: 100%;
  height: 200px;
  border-radius: 16px;
  border: 2px solid rgba(245,197,24,0.3);
  margin-bottom: 20px;
  overflow: hidden;
  position: relative;
  background: linear-gradient(135deg, #1a0d4a 0%, #0a1628 50%, #1a0505 100%);
}
.story-scene {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  position: relative;
}
.scene-emoji {
  font-size: 48px;
  position: absolute;
  filter: drop-shadow(0 0 15px rgba(245,197,24,0.8));
}

/* Floating magic effects in scene */
.magic-particle {
  position: absolute;
  animation: magicFloat var(--d,4s) ease-in-out infinite var(--dl,0s);
  font-size: var(--s,20px);
}
@keyframes magicFloat {
  0%,100% { transform: translate(0,0) rotate(0deg); opacity: 0.6; }
  33% { transform: translate(var(--tx,20px), var(--ty,-30px)) rotate(120deg); opacity: 1; }
  66% { transform: translate(calc(var(--tx,20px)*-0.5), var(--ty,-50px)) rotate(240deg); opacity: 0.8; }
}

/* Story text */
.story-body {
  background: linear-gradient(135deg, rgba(244,228,188,0.05) 0%, rgba(244,228,188,0.02) 100%);
  border: 1px solid rgba(245,197,24,0.15);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  position: relative;
}
.story-body::before {
  content: 'ğŸ“œ';
  position: absolute;
  top: -14px; left: 20px;
  font-size: 24px;
}

.story-paragraph {
  margin-bottom: 16px;
  cursor: pointer;
  transition: all 0.3s;
  border-radius: 8px;
  padding: 8px;
  border-left: 3px solid transparent;
}
.story-paragraph:hover { background: rgba(245,197,24,0.05); border-left-color: rgba(245,197,24,0.3); }
.story-paragraph.highlighted { background: rgba(245,197,24,0.1); border-left-color: var(--gold); }
.story-paragraph.reading { background: rgba(74,144,217,0.1); border-left-color: var(--magic-blue); animation: readingPulse 1s ease infinite; }
@keyframes readingPulse { 0%,100% { box-shadow: none; } 50% { box-shadow: 0 0 15px rgba(74,144,217,0.3); } }

.para-en {
  font-size: 15px;
  line-height: 1.8;
  color: var(--parchment);
  margin-bottom: 6px;
}
.para-zh {
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: 14px;
  line-height: 1.8;
  color: rgba(244,228,188,0.7);
  font-style: italic;
  border-left: 2px solid rgba(245,197,24,0.2);
  padding-left: 10px;
}

/* Story controls */
.story-controls {
  display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
  margin-bottom: 20px;
}
.story-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 20px;
  border-radius: 25px;
  border: 1px solid rgba(245,197,24,0.4);
  background: rgba(245,197,24,0.1);
  color: var(--gold);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Cinzel', serif;
}
.story-btn:hover { background: rgba(245,197,24,0.2); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(245,197,24,0.2); }
.story-btn.active { background: rgba(74,144,217,0.3); border-color: var(--magic-blue); color: var(--magic-glow); }
.story-btn.playing { animation: btnPulse 1s ease infinite; }
@keyframes btnPulse { 0%,100% { box-shadow: 0 0 10px rgba(74,144,217,0.3); } 50% { box-shadow: 0 0 25px rgba(74,144,217,0.6); } }

/* Speed control */
.speed-selector {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid rgba(245,197,24,0.2);
  background: rgba(0,0,0,0.3);
}
.speed-selector label { font-size: 12px; color: rgba(244,228,188,0.6); }
.speed-selector select {
  background: transparent; border: none; color: var(--gold);
  font-size: 12px; cursor: pointer; outline: none;
}
.speed-selector select option { background: #1a0d4a; }

/* ===== KNOWLEDGE CARDS ===== */
.knowledge-section {
  margin-top: 24px;
}
.section-title {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(to right, rgba(245,197,24,0.4), transparent);
}

.knowledge-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
}

.knowledge-card {
  border-radius: 16px;
  padding: 20px;
  border: 1px solid;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s;
}
.knowledge-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}
.knowledge-card::before {
  content: var(--icon);
  position: absolute;
  right: 16px; top: 16px;
  font-size: 28px;
  opacity: 0.3;
  transition: all 0.3s;
}
.knowledge-card:hover::before { opacity: 0.6; transform: scale(1.2); }

.kc-math { background: linear-gradient(135deg, rgba(74,144,217,0.15), rgba(74,144,217,0.05)); border-color: rgba(74,144,217,0.3); --icon: 'ğŸ”¢'; }
.kc-science { background: linear-gradient(135deg, rgba(50,180,80,0.15), rgba(50,180,80,0.05)); border-color: rgba(50,180,80,0.3); --icon: 'ğŸ”¬'; }
.kc-social { background: linear-gradient(135deg, rgba(240,120,60,0.15), rgba(240,120,60,0.05)); border-color: rgba(240,120,60,0.3); --icon: 'ğŸŒ'; }
.kc-english { background: linear-gradient(135deg, rgba(180,80,200,0.15), rgba(180,80,200,0.05)); border-color: rgba(180,80,200,0.3); --icon: 'ğŸ“š'; }

.kc-subject {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 8px;
  opacity: 0.7;
}
.kc-math .kc-subject { color: var(--magic-blue); }
.kc-science .kc-subject { color: #80e0a0; }
.kc-social .kc-subject { color: #f0a080; }
.kc-english .kc-subject { color: #d0a0e8; }

.kc-title { font-family: 'Cinzel', serif; font-size: 14px; font-weight: 600; color: var(--gold); margin-bottom: 6px; }
.kc-title-zh { font-family: 'ZCOOL XiaoWei', serif; font-size: 13px; color: var(--parchment); margin-bottom: 10px; opacity: 0.8; }
.kc-explanation { font-size: 13px; line-height: 1.7; color: rgba(244,228,188,0.75); }
.kc-explanation-zh { font-family: 'ZCOOL XiaoWei', serif; font-size: 12px; line-height: 1.7; color: rgba(244,228,188,0.6); margin-top: 8px; }

/* ===== DICTATION PANEL ===== */
.dictation-setup {
  background: linear-gradient(135deg, rgba(244,228,188,0.05), rgba(244,228,188,0.02));
  border: 1px solid rgba(245,197,24,0.2);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
}

.dictation-modes {
  display: flex; gap: 12px; flex-wrap: wrap;
  margin-bottom: 20px;
}
.mode-btn {
  flex: 1; min-width: 140px;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid rgba(245,197,24,0.2);
  background: rgba(0,0,0,0.3);
  color: var(--parchment);
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}
.mode-btn:hover, .mode-btn.active {
  border-color: var(--gold);
  background: rgba(245,197,24,0.1);
  color: var(--gold);
}
.mode-icon { font-size: 32px; display: block; margin-bottom: 8px; }
.mode-name { font-family: 'Cinzel', serif; font-size: 13px; }
.mode-desc { font-size: 11px; opacity: 0.6; margin-top: 4px; }

/* Word list for dictation */
.word-list {
  display: flex; gap: 8px; flex-wrap: wrap;
  margin-bottom: 20px;
}
.word-chip {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid rgba(245,197,24,0.3);
  background: rgba(245,197,24,0.05);
  font-size: 13px;
  color: var(--parchment);
  cursor: pointer;
  transition: all 0.3s;
}
.word-chip:hover { background: rgba(245,197,24,0.15); color: var(--gold); }
.word-chip.selected { background: rgba(74,144,217,0.2); border-color: var(--magic-blue); color: var(--magic-glow); }

.start-dictation-btn {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: 2px solid var(--gold);
  background: linear-gradient(135deg, rgba(245,197,24,0.2), rgba(245,197,24,0.1));
  color: var(--gold);
  font-family: 'Cinzel', serif;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.start-dictation-btn:hover {
  background: linear-gradient(135deg, rgba(245,197,24,0.35), rgba(245,197,24,0.2));
  box-shadow: 0 0 30px rgba(245,197,24,0.3);
  transform: translateY(-2px);
}

/* Dictation active */
.dictation-active {
  display: none;
  text-align: center;
  padding: 24px;
}
.dictation-active.show { display: block; }

.word-prompt {
  font-size: 40px;
  color: var(--gold);
  font-family: 'Cinzel', serif;
  margin: 20px 0;
  animation: wordAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes wordAppear {
  from { transform: scale(0.5) rotate(-5deg); opacity: 0; }
  to { transform: scale(1) rotate(0deg); opacity: 1; }
}

.word-hint { font-size: 13px; color: rgba(244,228,188,0.5); margin-bottom: 20px; }

.dictation-input {
  width: 100%;
  max-width: 400px;
  padding: 14px 20px;
  border-radius: 12px;
  border: 2px solid rgba(245,197,24,0.4);
  background: rgba(0,0,0,0.4);
  color: var(--parchment);
  font-size: 20px;
  text-align: center;
  outline: none;
  font-family: 'Cinzel', serif;
  transition: all 0.3s;
  letter-spacing: 3px;
}
.dictation-input:focus { border-color: var(--gold); box-shadow: 0 0 20px rgba(245,197,24,0.3); }
.dictation-input.correct { border-color: #80e0a0; color: #80e0a0; box-shadow: 0 0 20px rgba(80,200,80,0.4); }
.dictation-input.wrong { border-color: #ff6060; color: #ff6060; animation: shake 0.4s; }
@keyframes shake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.dictation-nav {
  display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap;
}
.dict-btn {
  padding: 10px 24px;
  border-radius: 20px;
  border: 1px solid rgba(245,197,24,0.4);
  background: rgba(245,197,24,0.1);
  color: var(--gold);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s;
}
.dict-btn:hover { background: rgba(245,197,24,0.2); }

.dictation-score {
  display: inline-flex; align-items: center; gap: 8px;
  background: rgba(245,197,24,0.1);
  border: 1px solid rgba(245,197,24,0.3);
  border-radius: 20px;
  padding: 6px 16px;
  font-family: 'Cinzel', serif;
  font-size: 14px;
  color: var(--gold);
  margin-bottom: 20px;
}

/* Progress bar */
.progress-bar {
  width: 100%; height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 20px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(to right, var(--magic-blue), var(--gold));
  border-radius: 3px;
  transition: width 0.5s ease;
}

/* Results */
.dictation-results {
  display: none;
  text-align: center;
  padding: 24px;
}
.dictation-results.show { display: block; animation: fadeInUp 0.5s ease; }
.result-emoji { font-size: 80px; animation: bounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes bounceIn { from { transform: scale(0); } 80% { transform: scale(1.2); } to { transform: scale(1); } }
.result-score { font-family: 'Cinzel', serif; font-size: 48px; color: var(--gold); margin: 16px 0; }
.result-msg { font-size: 16px; color: var(--parchment); margin-bottom: 20px; }
.result-breakdown { text-align: left; }
.result-item {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: 13px;
}
.result-item .word { color: var(--gold); font-family: 'Cinzel', serif; min-width: 120px; }
.result-item .answer { color: rgba(244,228,188,0.6); }
.result-item .status { margin-left: auto; }

/* ===== ACHIEVEMENTS / POINTS PANEL ===== */
.achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
}

.achievement-card {
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.1);
  padding: 20px 16px;
  text-align: center;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.achievement-card.earned {
  border-color: rgba(245,197,24,0.5);
  background: linear-gradient(135deg, rgba(245,197,24,0.1), rgba(245,197,24,0.05));
  box-shadow: 0 0 20px rgba(245,197,24,0.1);
}
.achievement-card.locked {
  background: rgba(0,0,0,0.3);
  filter: grayscale(0.8);
}
.achievement-icon { font-size: 40px; display: block; margin-bottom: 10px; }
.achievement-name { font-family: 'Cinzel', serif; font-size: 12px; color: var(--gold); margin-bottom: 4px; }
.achievement-desc { font-size: 11px; color: rgba(244,228,188,0.5); line-height: 1.4; }
.achievement-pts { font-size: 10px; color: var(--gold); margin-top: 6px; }
.achievement-badge {
  position: absolute; top: 8px; right: 8px;
  font-size: 16px;
}

/* House cup */
.house-cup {
  background: linear-gradient(135deg, rgba(245,197,24,0.1), rgba(245,197,24,0.05));
  border: 1px solid rgba(245,197,24,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}
.cup-title { font-family: 'Cinzel', serif; font-size: 16px; color: var(--gold); text-align: center; margin-bottom: 16px; }
.house-bars { display: flex; flex-direction: column; gap: 10px; }
.house-bar {
  display: flex; align-items: center; gap: 12px;
}
.house-bar-label { font-size: 13px; min-width: 100px; }
.house-bar-track {
  flex: 1; height: 12px;
  background: rgba(255,255,255,0.08);
  border-radius: 6px;
  overflow: hidden;
}
.house-bar-fill { height: 100%; border-radius: 6px; transition: width 1s ease; }
.house-bar-pts { font-size: 12px; color: var(--gold); min-width: 40px; text-align: right; }

/* ===== QUIZ PANEL ===== */
.quiz-container { max-width: 600px; margin: 0 auto; }
.quiz-question-num { font-size: 12px; color: rgba(244,228,188,0.5); margin-bottom: 8px; text-align: center; }
.quiz-question {
  background: linear-gradient(135deg, rgba(245,197,24,0.08), rgba(245,197,24,0.03));
  border: 1px solid rgba(245,197,24,0.2);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  font-size: 15px;
  line-height: 1.7;
  color: var(--parchment);
}
.quiz-question-zh { font-family: 'ZCOOL XiaoWei', serif; font-size: 14px; color: rgba(244,228,188,0.7); margin-top: 10px; }

.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-option {
  padding: 14px 20px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(0,0,0,0.3);
  color: var(--parchment);
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
  text-align: left;
  display: flex; align-items: center; gap: 12px;
}
.quiz-option:hover { border-color: rgba(245,197,24,0.4); background: rgba(245,197,24,0.08); }
.quiz-option.correct { border-color: #80e0a0; background: rgba(80,200,80,0.15); color: #80e0a0; }
.quiz-option.wrong { border-color: #ff6060; background: rgba(200,60,60,0.15); color: #ff8080; }
.quiz-option.disabled { cursor: not-allowed; pointer-events: none; }

.option-letter {
  width: 28px; height: 28px;
  border-radius: 50%;
  border: 1px solid currentColor;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-family: 'Cinzel', serif;
  flex-shrink: 0;
}

.quiz-feedback {
  display: none; padding: 16px; border-radius: 12px; margin-top: 12px;
  font-size: 14px; line-height: 1.6;
}
.quiz-feedback.show { display: block; animation: fadeInUp 0.4s ease; }
.quiz-feedback.correct { background: rgba(80,200,80,0.1); border: 1px solid rgba(80,200,80,0.3); color: #80e0a0; }
.quiz-feedback.wrong { background: rgba(200,60,60,0.1); border: 1px solid rgba(200,60,60,0.3); color: #ff8080; }

.quiz-next-btn {
  width: 100%; margin-top: 16px;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid rgba(245,197,24,0.4);
  background: rgba(245,197,24,0.1);
  color: var(--gold);
  font-family: 'Cinzel', serif;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  display: none;
}
.quiz-next-btn.show { display: block; }
.quiz-next-btn:hover { background: rgba(245,197,24,0.2); }

/* ===== POINTS ANIMATION ===== */
.points-pop {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  font-family: 'Cinzel', serif;
  font-size: 20px;
  color: var(--gold);
  font-weight: bold;
  text-shadow: 0 0 10px rgba(245,197,24,0.8);
  animation: pointsPop 1.5s ease forwards;
}
@keyframes pointsPop {
  0% { opacity: 0; transform: translateY(0) scale(0.5); }
  20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
  80% { opacity: 1; transform: translateY(-60px) scale(1); }
  100% { opacity: 0; transform: translateY(-80px) scale(0.8); }
}

/* ===== CALENDAR ===== */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 20px;
}
.cal-day {
  aspect-ratio: 1;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
}
.cal-day.completed { background: rgba(245,197,24,0.15); border-color: rgba(245,197,24,0.3); color: var(--gold); }
.cal-day.today { background: rgba(74,144,217,0.2); border-color: var(--magic-blue); color: var(--magic-glow); font-weight: bold; }
.cal-day.empty { opacity: 0; pointer-events: none; }
.cal-day:hover:not(.empty) { background: rgba(255,255,255,0.05); }

/* ===== LOADING/MAGIC EFFECT ===== */
.magic-loading {
  position: fixed; inset: 0; z-index: 9000;
  background: radial-gradient(ellipse at center, #1a0d4a 0%, #0a0a1a 100%);
  display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;
}
.magic-loading.hidden { display: none; } /* fallback */
.loading-wand { font-size: 60px; animation: wandMagic 1s ease-in-out infinite; }
@keyframes wandMagic {
  0%,100% { transform: rotate(-20deg) scale(1); }
  50% { transform: rotate(20deg) scale(1.1); filter: drop-shadow(0 0 20px var(--gold)); }
}
.loading-text { font-family: 'Cinzel', serif; font-size: 18px; color: var(--gold); letter-spacing: 2px; }
.loading-dots::after {
  content: '';
  animation: dots 1.5s steps(4) infinite;
}
@keyframes dots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  .panel { padding: 12px; }
  .knowledge-cards { grid-template-columns: 1fr; }
  .character-grid { grid-template-columns: repeat(2, 1fr); }
  .dictation-modes { flex-direction: column; }
}

/* Custom scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
::-webkit-scrollbar-thumb { background: rgba(245,197,24,0.3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(245,197,24,0.5); }

/* Tooltip */
.tooltip {
  position: relative;
}
.tooltip::after {
  content: attr(data-tip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(10,10,26,0.95);
  border: 1px solid rgba(245,197,24,0.3);
  color: var(--parchment);
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 8px;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}
.tooltip:hover::after { opacity: 1; }

</style>
</head>
<body>

<!-- Stars Background -->
<div class="stars-bg" id="stars-bg"></div>

<!-- Loading Screen -->
<div class="magic-loading" id="loading-screen">
  <div class="loading-wand">ğŸª„</div>
  <div class="loading-text">æ–½å±•é­”æ³•ä¸­<span class="loading-dots"></span></div>
  <div style="font-size:13px;color:rgba(244,228,188,0.5);">Casting spells of knowledge...</div>
</div>

<!-- Character Select Screen -->
<div class="screen" id="screen-character">
  <div style="text-align:center;margin-bottom:30px;">
    <div class="hogwarts-crest">âš¡</div>
    <div class="title-main">Wizard Academy</div>
    <div class="title-sub">é­”æ³•å­¦é™¢ Â· çŸ¥è¯†ä¹‹æ—…</div>
    <div style="font-size:13px;color:rgba(244,228,188,0.5);margin-top:10px;">é€‰æ‹©ä½ çš„é­”æ³•å¸ˆè§’è‰² Â· Choose your wizard</div>
  </div>

  <div class="character-grid">
    <div class="character-card house-gryffindor" onclick="selectCharacter('harry','âš¡','Harry Potter','å“ˆåˆ©Â·æ³¢ç‰¹','æ ¼å…°èŠ¬å¤š','å‹‡æ•¢æ— ç•')">
      <span class="char-avatar">âš¡</span>
      <div class="char-name-en">Harry Potter</div>
      <div class="char-name-zh">å“ˆåˆ©Â·æ³¢ç‰¹</div>
      <span class="char-house">æ ¼å…°èŠ¬å¤š Â· Gryffindor</span>
      <div class="char-trait">å‹‡æ•¢æ— ç• Â· Brave & Bold</div>
    </div>
    <div class="character-card house-gryffindor" onclick="selectCharacter('hermione','ğŸ“š','Hermione Granger','èµ«æ•Â·æ ¼å…°æ°','æ ¼å…°èŠ¬å¤š','æ™ºæ…§å¥½å­¦')">
      <span class="char-avatar">ğŸ“š</span>
      <div class="char-name-en">Hermione Granger</div>
      <div class="char-name-zh">èµ«æ•Â·æ ¼å…°æ°</div>
      <span class="char-house">æ ¼å…°èŠ¬å¤š Â· Gryffindor</span>
      <div class="char-trait">æ™ºæ…§å¥½å­¦ Â· Wise & Studious</div>
    </div>
    <div class="character-card house-gryffindor" onclick="selectCharacter('ron','ğŸ®','Ron Weasley','ç½—æ©Â·éŸ¦æ–¯è±','æ ¼å…°èŠ¬å¤š','å¿ è¯šå‹‡æ•¢')">
      <span class="char-avatar">ğŸ®</span>
      <div class="char-name-en">Ron Weasley</div>
      <div class="char-name-zh">ç½—æ©Â·éŸ¦æ–¯è±</div>
      <span class="char-house">æ ¼å…°èŠ¬å¤š Â· Gryffindor</span>
      <div class="char-trait">å¿ è¯šå‹‡æ•¢ Â· Loyal & Brave</div>
    </div>
    <div class="character-card house-hufflepuff" onclick="selectCharacter('neville','ğŸŒ¿','Neville Longbottom','çº³å¨Â·éš†å·´é¡¿','èµ«å¥‡å¸•å¥‡','åšæŒä¸æ‡ˆ')">
      <span class="char-avatar">ğŸŒ¿</span>
      <div class="char-name-en">Neville Longbottom</div>
      <div class="char-name-zh">çº³å¨Â·éš†å·´é¡¿</div>
      <span class="char-house">èµ«å¥‡å¸•å¥‡ Â· Hufflepuff</span>
      <div class="char-trait">åšæŒä¸æ‡ˆ Â· Persistent</div>
    </div>
    <div class="character-card house-ravenclaw" onclick="selectCharacter('luna','ğŸŒ™','Luna Lovegood','å¢å¨œÂ·æ´›å¤«å¤å¾·','æ‹‰æ–‡å…‹åŠ³','å¥‡æ€å¦™æƒ³')">
      <span class="char-avatar">ğŸŒ™</span>
      <div class="char-name-en">Luna Lovegood</div>
      <div class="char-name-zh">å¢å¨œÂ·æ´›å¤«å¤å¾·</div>
      <span class="char-house">æ‹‰æ–‡å…‹åŠ³ Â· Ravenclaw</span>
      <div class="char-trait">å¥‡æ€å¦™æƒ³ Â· Creative</div>
    </div>
    <div class="character-card house-slytherin" onclick="selectCharacter('draco','ğŸ','Draco Malfoy','å¾·æ‹‰ç§‘Â·é©¬å°”ç¦','æ–¯è±ç‰¹æ—','é›„å¿ƒå£®å¿—')">
      <span class="char-avatar">ğŸ</span>
      <div class="char-name-en">Draco Malfoy</div>
      <div class="char-name-zh">å¾·æ‹‰ç§‘Â·é©¬å°”ç¦</div>
      <span class="char-house">æ–¯è±ç‰¹æ— Â· Slytherin</span>
      <div class="char-trait">é›„å¿ƒå£®å¿— Â· Ambitious</div>
    </div>
  </div>
</div>

<!-- Main App Screen -->
<div class="screen" id="screen-main">
  <!-- Header -->
  <div class="app-header">
    <div class="header-left">
      <div class="player-avatar-sm" id="header-avatar" onclick="goToCharacterSelect()" title="æ›´æ¢è§’è‰²">âš¡</div>
      <div class="player-info">
        <div class="player-name" id="header-name">Harry Potter</div>
        <div class="player-house" id="header-house">æ ¼å…°èŠ¬å¤š</div>
      </div>
    </div>
    <div class="header-center">ğŸ° é­”æ³•å­¦é™¢ Â· Wizard Academy</div>
    <div class="header-right">
      <div class="day-badge">ğŸ“… ç¬¬ <span id="day-num">1</span> å¤©</div>
      <div class="points-display">
        <span class="points-star">â­</span>
        <span id="total-points">0</span> åˆ†
      </div>
    </div>
  </div>

  <!-- Nav -->
  <div class="app-nav">
    <button class="nav-btn active" onclick="showPanel('story')" id="nav-story">ğŸ“– ä»Šæ—¥æ•…äº‹</button>
    <button class="nav-btn" onclick="showPanel('knowledge')" id="nav-knowledge">ğŸ’¡ çŸ¥è¯†ç‚¹</button>
    <button class="nav-btn" onclick="showPanel('quiz')" id="nav-quiz">ğŸ§™ é­”æ³•æµ‹éªŒ</button>
    <button class="nav-btn" onclick="showPanel('dictation')" id="nav-dictation">âœï¸ å¬å†™ç»ƒä¹ </button>
    <button class="nav-btn" onclick="showPanel('achievements')" id="nav-achievements">ğŸ† æˆå°±å¥–æ¯</button>
    <button class="nav-btn" onclick="showPanel('calendar')" id="nav-calendar">ğŸ“… å­¦ä¹ æ—¥å†</button>
  </div>

  <!-- Story Panel -->
  <div class="panel active" id="panel-story">
    <div class="story-date-header">
      <div class="story-date" id="story-date-display"></div>
      <div class="story-title" id="story-title-en"></div>
      <div class="story-subtitle" id="story-title-zh"></div>
      <div class="story-subject-tags" id="story-tags"></div>
    </div>

    <!-- Illustration -->
    <div class="story-illustration">
      <div class="story-scene" id="story-scene"></div>
    </div>

    <!-- Controls -->
    <div class="story-controls">
      <button class="story-btn" id="btn-read-all" onclick="toggleReadAll()">ğŸ”Š æœ—è¯»å…¨æ–‡</button>
      <button class="story-btn" id="btn-para-read" onclick="toggleParaMode()">ğŸ“ æ®µè½æ¨¡å¼</button>
      <div class="speed-selector">
        <label>è¯­é€Ÿï¼š</label>
        <select id="speed-select" onchange="updateSpeed()">
          <option value="0.7">æ…¢é€Ÿ</option>
          <option value="1.0" selected>æ­£å¸¸</option>
          <option value="1.3">å¿«é€Ÿ</option>
        </select>
      </div>
      <button class="story-btn" onclick="stopSpeech()">â¹ åœæ­¢</button>
    </div>

    <!-- Story Body -->
    <div class="story-body" id="story-body"></div>

    <div class="knowledge-section">
      <div class="section-title">ğŸ“š ä»Šæ—¥çŸ¥è¯†ç‚¹ Â· Today's Knowledge</div>
      <div class="knowledge-cards" id="inline-knowledge-cards"></div>
    </div>
  </div>

  <!-- Knowledge Panel -->
  <div class="panel" id="panel-knowledge">
    <div class="section-title">ğŸ’¡ çŸ¥è¯†å®åº“ Â· Knowledge Treasury</div>
    <div class="knowledge-cards" id="knowledge-cards-full"></div>
  </div>

  <!-- Quiz Panel -->
  <div class="panel" id="panel-quiz">
    <div class="quiz-container">
      <div id="quiz-intro">
        <div style="text-align:center;padding:40px 20px;">
          <div style="font-size:60px;margin-bottom:16px;">ğŸ§™â€â™‚ï¸</div>
          <div class="section-title" style="justify-content:center;">é­”æ³•æµ‹éªŒ Â· Magic Quiz</div>
          <div style="font-size:14px;color:rgba(244,228,188,0.6);margin:12px 0 24px;">å›ç­”é—®é¢˜ï¼Œèµ¢å–å·«å¸ˆç§¯åˆ†ï¼<br>Answer questions and earn wizard points!</div>
          <button class="start-dictation-btn" onclick="startQuiz()" style="max-width:300px;margin:0 auto;">
            ğŸª„ å¼€å§‹æµ‹éªŒ Â· Start Quiz
          </button>
        </div>
      </div>
      <div id="quiz-active" style="display:none;">
        <div class="quiz-question-num" id="quiz-num">Question 1 / 5</div>
        <div class="progress-bar"><div class="progress-fill" id="quiz-progress" style="width:20%"></div></div>
        <div class="quiz-question">
          <div id="quiz-q-en"></div>
          <div class="quiz-question-zh" id="quiz-q-zh"></div>
        </div>
        <div class="quiz-options" id="quiz-options"></div>
        <div class="quiz-feedback" id="quiz-feedback"></div>
        <button class="quiz-next-btn" id="quiz-next" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ Â· Next â†’</button>
      </div>
      <div id="quiz-done" style="display:none;text-align:center;padding:40px 20px;">
        <div class="result-emoji" id="quiz-result-emoji">ğŸ†</div>
        <div class="result-score" id="quiz-result-score">5/5</div>
        <div class="result-msg" id="quiz-result-msg"></div>
        <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
          <button class="story-btn" onclick="startQuiz()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
          <button class="story-btn" onclick="showPanel('story')">ğŸ“– è¿”å›æ•…äº‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dictation Panel -->
  <div class="panel" id="panel-dictation">
    <div class="section-title">âœï¸ å¬å†™ç»ƒä¹  Â· Spelling Practice</div>

    <div class="dictation-setup" id="dictation-setup">
      <div style="font-size:14px;color:rgba(244,228,188,0.7);margin-bottom:16px;">
        é€‰æ‹©ç»ƒä¹ æ¨¡å¼ Â· Choose practice mode
      </div>
      <div class="dictation-modes">
        <div class="mode-btn active" onclick="selectMode(this,'word')" data-mode="word">
          <span class="mode-icon">ğŸ“</span>
          <div class="mode-name">å•è¯å¬å†™</div>
          <div class="mode-desc">Word Dictation</div>
        </div>
        <div class="mode-btn" onclick="selectMode(this,'sentence')" data-mode="sentence">
          <span class="mode-icon">ğŸ“œ</span>
          <div class="mode-name">å¥å­å¡«ç©º</div>
          <div class="mode-desc">Fill in Blanks</div>
        </div>
        <div class="mode-btn" onclick="selectMode(this,'spell')" data-mode="spell">
          <span class="mode-icon">ğŸ”¤</span>
          <div class="mode-name">æ‹¼å†™æŒ‘æˆ˜</div>
          <div class="mode-desc">Spelling Bee</div>
        </div>
      </div>

      <div style="font-size:13px;color:rgba(244,228,188,0.6);margin-bottom:10px;">é€‰æ‹©è¯æ±‡ Â· Select words:</div>
      <div class="word-list" id="word-list"></div>

      <button class="start-dictation-btn" onclick="startDictation()">
        ğŸª„ å¼€å§‹å¬å†™ Â· Start Practice
      </button>
    </div>

    <div class="dictation-active" id="dictation-active">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div class="dictation-score">â­ <span id="dict-score">0</span></div>
        <div style="font-size:12px;color:rgba(244,228,188,0.5);">
          <span id="dict-current">1</span> / <span id="dict-total">10</span>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="dict-progress" style="width:0%"></div></div>

      <div style="font-size:13px;color:rgba(244,228,188,0.5);margin-bottom:8px;" id="dict-mode-hint"></div>
      <div class="word-prompt" id="dict-prompt">ğŸ”Š</div>
      <div class="word-hint" id="dict-hint"></div>

      <input type="text" class="dictation-input" id="dict-input"
        placeholder="è¾“å…¥å•è¯..." autocomplete="off" autocorrect="off"
        onkeydown="handleDictKey(event)">

      <div class="dictation-nav">
        <button class="dict-btn" onclick="replayWord()">ğŸ”Š å†å¬ä¸€æ¬¡</button>
        <button class="dict-btn" onclick="showHint()">ğŸ’¡ æç¤º</button>
        <button class="dict-btn" onclick="checkDictation()">âœ… ç¡®è®¤</button>
        <button class="dict-btn" onclick="skipWord()">â­ è·³è¿‡</button>
      </div>
    </div>

    <div class="dictation-results" id="dictation-results">
      <div class="result-emoji" id="dict-result-emoji">ğŸŒŸ</div>
      <div class="result-score" id="dict-result-score">8/10</div>
      <div class="result-msg" id="dict-result-msg"></div>
      <div class="result-breakdown" id="dict-breakdown"></div>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap;">
        <button class="story-btn" onclick="resetDictation()">ğŸ”„ å†æ¥ä¸€æ¬¡</button>
        <button class="story-btn" onclick="showPanel('story')">ğŸ“– è¿”å›æ•…äº‹</button>
      </div>
    </div>
  </div>

  <!-- Achievements Panel -->
  <div class="panel" id="panel-achievements">
    <div class="house-cup">
      <div class="cup-title">ğŸ† å­¦é™¢ç§¯åˆ†æ¦œ Â· House Cup</div>
      <div class="house-bars" id="house-bars"></div>
    </div>

    <div class="section-title">ğŸ–ï¸ æˆ‘çš„æˆå°± Â· My Achievements</div>
    <div class="achievements-grid" id="achievements-grid"></div>
  </div>

  <!-- Calendar Panel -->
  <div class="panel" id="panel-calendar">
    <div class="section-title">ğŸ“… å­¦ä¹ æ—¥å† Â· Study Calendar</div>
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-family:'Cinzel',serif;font-size:18px;color:var(--gold);" id="cal-month-title"></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px;">
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">æ—¥</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">ä¸€</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">äºŒ</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">ä¸‰</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">å››</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">äº”</div>
      <div style="text-align:center;font-size:11px;color:rgba(244,228,188,0.4);">å…­</div>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>

    <div class="section-title" style="margin-top:24px;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡ Â· Stats</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
      <div style="background:rgba(245,197,24,0.08);border:1px solid rgba(245,197,24,0.2);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:32px;font-family:'Cinzel',serif;color:var(--gold);" id="stat-streak">0</div>
        <div style="font-size:12px;color:rgba(244,228,188,0.6);">ğŸ”¥ è¿ç»­å¤©æ•° Streak</div>
      </div>
      <div style="background:rgba(74,144,217,0.08);border:1px solid rgba(74,144,217,0.2);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:32px;font-family:'Cinzel',serif;color:var(--magic-blue);" id="stat-stories">0</div>
        <div style="font-size:12px;color:rgba(244,228,188,0.6);">ğŸ“– æ•…äº‹é˜…è¯» Stories</div>
      </div>
      <div style="background:rgba(80,200,80,0.08);border:1px solid rgba(80,200,80,0.2);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:32px;font-family:'Cinzel',serif;color:#80e0a0;" id="stat-quizzes">0</div>
        <div style="font-size:12px;color:rgba(244,228,188,0.6);">ğŸ§™ æµ‹éªŒå®Œæˆ Quizzes</div>
      </div>
      <div style="background:rgba(200,80,200,0.08);border:1px solid rgba(200,80,200,0.2);border-radius:12px;padding:16px;text-align:center;">
        <div style="font-size:32px;font-family:'Cinzel',serif;color:#d0a0e8;" id="stat-words">0</div>
        <div style="font-size:12px;color:rgba(244,228,188,0.6);">âœï¸ å•è¯æŒæ¡ Words</div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA - Stories, Knowledge, Quizzes
// ============================================================

const STORIES = [
  {
    day: 1,
    titleEn: "Harry's Magical Mathematics at Hogwarts",
    titleZh: "å“ˆåˆ©åœ¨éœæ ¼æ²ƒèŒ¨çš„é­”æ³•æ•°å­¦",
    subjects: ['math','science'],
    scene: {
      emojis: [
        {e:'âš¡',x:'50%',y:'40%',main:true},
        {e:'ğŸ”¢',x:'20%',y:'60%'},{e:'âœ¨',x:'80%',y:'30%'},
        {e:'ğŸ“',x:'30%',y:'30%'},{e:'ğŸŒŸ',x:'70%',y:'70%'}
      ],
      bg: 'linear-gradient(135deg, #1a0d4a 0%, #0a1628 50%, #1a0a05 100%)'
    },
    paragraphs: [
      {
        en: "One crisp autumn morning at Hogwarts, Professor McGonagall announced a special lesson. \"Today,\" she said with a twinkle in her eye, \"we will use fractions to brew the most powerful potions!\" Harry Potter sat up straight, excited. Fractions were a type of number that showed parts of a whole â€” like how Â½ meant one out of two equal parts.",
        zh: "åœ¨éœæ ¼æ²ƒèŒ¨ä¸€ä¸ªæ¸…çˆ½çš„ç§‹æ—¥æ—©æ™¨ï¼Œéº¦æ ¼æ•™æˆå®£å¸ƒäº†ä¸€å ‚ç‰¹åˆ«è¯¾ã€‚"ä»Šå¤©ï¼Œ"å¥¹çœ¼ç›é—ªé—ªå‘å…‰åœ°è¯´ï¼Œ"æˆ‘ä»¬è¦ç”¨åˆ†æ•°æ¥è°ƒåˆ¶æœ€å¼ºå¤§çš„é­”æ³•è¯æ°´ï¼"å“ˆåˆ©Â·æ³¢ç‰¹åç›´äº†èº«å­ï¼Œéå¸¸å…´å¥‹ã€‚åˆ†æ•°æ˜¯ä¸€ç§è¡¨ç¤ºæ•´ä½“ä¸€éƒ¨åˆ†çš„æ•°â€”â€”æ¯”å¦‚Â½è¡¨ç¤ºä¸¤ä¸ªç›¸ç­‰éƒ¨åˆ†ä¸­çš„ä¸€ä¸ªã€‚"
      },
      {
        en: "Hermione leaned over and whispered, \"Harry, a fraction has two parts: the numerator on top tells us how many pieces we have, and the denominator on the bottom tells us how many equal pieces the whole is divided into.\" She drew it on parchment: **3/4** â€” three pieces out of four equal parts. \"So if a potion bottle holds 4 doses and we use 3, we've used three-quarters of the bottle!\"",
        zh: 'èµ«æ•å‡‘è¿‡æ¥æ‚„å£°è¯´ï¼š"å“ˆåˆ©ï¼Œä¸€ä¸ªåˆ†æ•°æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸Šé¢çš„åˆ†å­å‘Šè¯‰æˆ‘ä»¬æœ‰å‡ ä»½ï¼Œä¸‹é¢çš„åˆ†æ¯å‘Šè¯‰æˆ‘ä»¬æ•´ä½“è¢«å¹³å‡åˆ†æˆå‡ ä»½ã€‚"å¥¹åœ¨ç¾Šçš®çº¸ä¸Šå†™ä¸‹ï¼š3/4â€”â€”å››ä¸ªç›¸ç­‰éƒ¨åˆ†ä¸­çš„ä¸‰ä»½ã€‚"æ‰€ä»¥å¦‚æœä¸€ç“¶è¯æ°´æœ‰4å‰‚é‡ï¼Œæˆ‘ä»¬ç”¨äº†3å‰‚ï¼Œå°±ç”¨äº†è¿™ç“¶çš„å››åˆ†ä¹‹ä¸‰ï¼"'
      },
      {
        en: "Professor McGonagall waved her wand and a cauldron appeared. \"To make Felix Felicis â€” the luck potion â€” you need Â½ cup of moonwater, Â¼ cup of starlight essence, and Â¼ cup of golden pollen. What do those fractions add up to?\" Ron scratched his head. Harry thought carefully: Â½ + Â¼ + Â¼. He converted Â½ to Â²â„â‚„, then added: Â²â„â‚„ + Â¼ + Â¼ = â´â„â‚„ = 1. \"One whole cup total!\" Harry shouted triumphantly.",
        zh: "éº¦æ ¼æ•™æˆæŒ¥åŠ¨é­”æ–ï¼Œä¸€å£å¤§é”…å‡ºç°äº†ã€‚"è¦åˆ¶ä½œè²åŠ›Â·è²åˆ©æ–¯â€”â€”å¹¸è¿è¯æ°´â€”â€”ä½ éœ€è¦Â½æ¯æœˆäº®æ°´ã€Â¼æ¯æ˜Ÿå…‰ç²¾åå’ŒÂ¼æ¯é»„é‡‘èŠ±ç²‰ã€‚è¿™äº›åˆ†æ•°åŠ èµ·æ¥æ˜¯å¤šå°‘ï¼Ÿ"ç½—æ©æŠ“äº†æŠ“å¤´ã€‚å“ˆåˆ©ä»”ç»†æ€è€ƒï¼šÂ½ + Â¼ + Â¼ã€‚ä»–æŠŠÂ½æ¢ç®—æˆÂ²â„â‚„ï¼Œç„¶åç›¸åŠ ï¼šÂ²â„â‚„ + Â¼ + Â¼ = â´â„â‚„ = 1ã€‚"æ€»å…±ä¸€æ•´æ¯ï¼"å“ˆåˆ©èƒœåˆ©åœ°å–Šé“ã€‚"
      },
      {
        en: "Suddenly, Neville knocked over his cauldron and blue liquid spread across the floor in a perfect circle. \"Excellent!\" cried Professor Sprout, who happened to be passing by. \"A real-world example of area! The space inside a circle is called its area. We measure it in square units.\" The blue puddle reminded everyone that math was everywhere in the magical world â€” even in accidents!",
        zh: "çªç„¶ï¼Œçº³å¨æ’ç¿»äº†ä»–çš„å¤§é”…ï¼Œè“è‰²æ¶²ä½“åœ¨åœ°æ¿ä¸Šå½¢æˆäº†ä¸€ä¸ªå®Œç¾çš„åœ†åœˆã€‚"å¤ªæ£’äº†ï¼"è·¯è¿‡çš„æ–¯æ™®åŠ³ç‰¹æ•™æˆå«é“ã€‚"è¿™æ˜¯é¢ç§¯çš„ç°å®æ¡ˆä¾‹ï¼åœ†åœˆå†…éƒ¨çš„ç©ºé—´å«åšé¢ç§¯ï¼Œæˆ‘ä»¬ç”¨å¹³æ–¹å•ä½æ¥æµ‹é‡å®ƒã€‚"é‚£æ»©è“è‰²æ¶²ä½“è®©æ‰€æœ‰äººéƒ½è®°ä½äº†â€”â€”æ•°å­¦æ— å¤„ä¸åœ¨ï¼Œå°±è¿åœ¨é­”æ³•ä¸–ç•Œçš„æ„å¤–äº‹æ•…ä¸­ä¹Ÿæ˜¯ï¼"
      }
    ],
    knowledge: [
      {
        subject: 'math', type: 'kc-math',
        titleEn: 'Understanding Fractions',
        titleZh: 'ç†è§£åˆ†æ•°',
        explanation: 'A fraction represents equal parts of a whole. The top number (numerator) tells how many parts we have. The bottom number (denominator) tells how many equal parts make up the whole. Example: 3/4 means 3 out of 4 equal parts.',
        explanationZh: 'åˆ†æ•°è¡¨ç¤ºæ•´ä½“çš„ç›¸ç­‰éƒ¨åˆ†ã€‚ä¸Šé¢çš„æ•°å­—ï¼ˆåˆ†å­ï¼‰è¡¨ç¤ºæˆ‘ä»¬æœ‰å¤šå°‘ä»½ã€‚ä¸‹é¢çš„æ•°å­—ï¼ˆåˆ†æ¯ï¼‰è¡¨ç¤ºæ•´ä½“è¢«åˆ†æˆå¤šå°‘ç­‰ä»½ã€‚ä¾‹å¦‚ï¼š3/4è¡¨ç¤º4ç­‰ä»½ä¸­çš„3ä»½ã€‚',
        magicLink: 'Like measuring potion ingredients! å°±åƒæµ‹é‡è¯æ°´é…æ–™ï¼'
      },
      {
        subject: 'math', type: 'kc-math',
        titleEn: 'Adding Fractions',
        titleZh: 'åˆ†æ•°åŠ æ³•',
        explanation: 'To add fractions with different denominators, find a common denominator first. Example: 1/2 + 1/4 = 2/4 + 1/4 = 3/4. Same denominator? Just add the numerators!',
        explanationZh: 'è¦æŠŠåˆ†æ¯ä¸åŒçš„åˆ†æ•°ç›¸åŠ ï¼Œå…ˆæ‰¾åˆ°å…¬åˆ†æ¯ã€‚ä¾‹å¦‚ï¼š1/2 + 1/4 = 2/4 + 1/4 = 3/4ã€‚åˆ†æ¯ç›¸åŒï¼Ÿç›´æ¥åŠ åˆ†å­ï¼',
        magicLink: 'Combining potion ingredients! åˆå¹¶è¯æ°´åŸæ–™ï¼'
      },
      {
        subject: 'science', type: 'kc-science',
        titleEn: 'States of Matter',
        titleZh: 'ç‰©è´¨çš„çŠ¶æ€',
        explanation: 'Matter exists in three main states: solid (fixed shape), liquid (takes shape of container), and gas (fills all available space). Water can be ice (solid), liquid water, or steam (gas).',
        explanationZh: 'ç‰©è´¨æœ‰ä¸‰ç§ä¸»è¦çŠ¶æ€ï¼šå›ºä½“ï¼ˆå½¢çŠ¶å›ºå®šï¼‰ã€æ¶²ä½“ï¼ˆå½¢çŠ¶éšå®¹å™¨å˜åŒ–ï¼‰å’Œæ°”ä½“ï¼ˆå……æ»¡æ‰€æœ‰å¯ç”¨ç©ºé—´ï¼‰ã€‚æ°´å¯ä»¥æ˜¯å†°ï¼ˆå›ºä½“ï¼‰ã€æ¶²æ€æ°´æˆ–è’¸æ±½ï¼ˆæ°”ä½“ï¼‰ã€‚',
        magicLink: 'Potions change state when heated! è¯æ°´åŠ çƒ­æ—¶ä¼šæ”¹å˜çŠ¶æ€ï¼'
      }
    ],
    vocab: ['fraction', 'numerator', 'denominator', 'equivalent', 'cauldron', 'formula', 'mixture', 'ingredient'],
    quiz: [
      {
        qEn: "Harry needs Â½ cup of moonwater and Â¼ cup of starlight. How much liquid is that in total?",
        qZh: "å“ˆåˆ©éœ€è¦Â½æ¯æœˆäº®æ°´å’ŒÂ¼æ¯æ˜Ÿå…‰ã€‚æ€»å…±æ˜¯å¤šå°‘æ¶²ä½“ï¼Ÿ",
        options: ['Â¾ cup', 'Â½ cup', '1 cup', 'â…” cup'],
        correct: 0,
        feedback: "Correct! Â½ = Â²â„â‚„, so Â²â„â‚„ + Â¼ = Â¾ cup. You're a great fraction wizard! æ­£ç¡®ï¼Â½ = Â²â„â‚„ï¼Œæ‰€ä»¥Â²â„â‚„ + Â¼ = Â¾æ¯ã€‚ä½ æ˜¯åˆ†æ•°é­”æ³•å¸ˆï¼"
      },
      {
        qEn: "In a fraction, what does the DENOMINATOR (bottom number) tell us?",
        qZh: "åœ¨åˆ†æ•°ä¸­ï¼Œåˆ†æ¯ï¼ˆä¸‹é¢çš„æ•°ï¼‰å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ",
        options: ['How many parts we have', 'How many equal parts make the whole', 'The total amount', 'The type of fraction'],
        correct: 1,
        feedback: "Exactly! The denominator shows how many equal pieces the whole is divided into. æ­£ç¡®ï¼åˆ†æ¯è¡¨ç¤ºæ•´ä½“è¢«åˆ†æˆå¤šå°‘ä¸ªç›¸ç­‰çš„éƒ¨åˆ†ã€‚"
      },
      {
        qEn: "Neville's potion created a puddle in the shape of a circle. What do we call the space INSIDE a 2D shape?",
        qZh: "çº³å¨çš„è¯æ°´å½¢æˆäº†ä¸€ä¸ªåœ†å½¢æ°´å‘ã€‚æˆ‘ä»¬æŠŠäºŒç»´å›¾å½¢å†…éƒ¨çš„ç©ºé—´å«åšä»€ä¹ˆï¼Ÿ",
        options: ['Perimeter', 'Volume', 'Area', 'Diameter'],
        correct: 2,
        feedback: "Right! Area is the measurement of the space inside a 2D shape. æ­£ç¡®ï¼é¢ç§¯æ˜¯äºŒç»´å›¾å½¢å†…éƒ¨ç©ºé—´çš„åº¦é‡ã€‚"
      },
      {
        qEn: "Which state of matter takes the shape of its container?",
        qZh: "å“ªç§ç‰©è´¨çŠ¶æ€ä¼šéšå®¹å™¨å½¢çŠ¶æ”¹å˜ï¼Ÿ",
        options: ['Solid', 'Liquid', 'Gas', 'All of them'],
        correct: 1,
        feedback: "Correct! Liquids flow and take the shape of whatever container holds them â€” just like potions! æ­£ç¡®ï¼æ¶²ä½“æµåŠ¨å¹¶éšå®¹å™¨å½¢çŠ¶æ”¹å˜â€”â€”å°±åƒè¯æ°´ä¸€æ ·ï¼"
      },
      {
        qEn: "What is Â²â„â‚„ equal to in its simplest form?",
        qZh: "Â²â„â‚„åŒ–ç®€åç­‰äºå¤šå°‘ï¼Ÿ",
        options: ['â…“', 'Â½', 'Â¾', 'â…”'],
        correct: 1,
        feedback: "Well done! Â²â„â‚„ = Â½ because both numerator and denominator can be divided by 2. åšå¾—å¥½ï¼Â²â„â‚„ = Â½ï¼Œå› ä¸ºåˆ†å­å’Œåˆ†æ¯éƒ½å¯ä»¥è¢«2æ•´é™¤ã€‚"
      }
    ]
  },
  {
    day: 2,
    titleEn: "Hermione and the Water Cycle of the Forbidden Forest",
    titleZh: "èµ«æ•ä¸ç¦å¿Œæ£®æ—çš„æ°´å¾ªç¯",
    subjects: ['science', 'social'],
    scene: {
      emojis: [
        {e:'ğŸŒ§ï¸',x:'50%',y:'35%',main:true},
        {e:'ğŸŒ¿',x:'20%',y:'65%'},{e:'â˜€ï¸',x:'80%',y:'25%'},
        {e:'ğŸ’§',x:'35%',y:'55%'},{e:'â˜ï¸',x:'65%',y:'45%'}
      ],
      bg: 'linear-gradient(135deg, #0a1a0a 0%, #0a1628 50%, #0d0a05 100%)'
    },
    paragraphs: [
      {
        en: "Hermione Granger had always been fascinated by how nature worked. On a rainy Tuesday, she led Harry and Ron into the Forbidden Forest to observe the water cycle in action. \"The water cycle is one of nature's greatest processes,\" she explained, her wand illuminating a small stream. \"It describes how water moves continuously through our environment.\"",
        zh: "èµ«æ•Â·æ ¼å…°æ°ä¸€ç›´å¯¹è‡ªç„¶è§„å¾‹å……æ»¡å¥½å¥‡ã€‚åœ¨ä¸€ä¸ªä¸‹é›¨çš„æ˜ŸæœŸäºŒï¼Œå¥¹å¸¦ç€å“ˆåˆ©å’Œç½—æ©è¿›å…¥ç¦å¿Œæ£®æ—ï¼Œäº²çœ¼è§‚å¯Ÿæ°´å¾ªç¯çš„è¿ä½œã€‚"æ°´å¾ªç¯æ˜¯å¤§è‡ªç„¶æœ€ä¼Ÿå¤§çš„è¿‡ç¨‹ä¹‹ä¸€ï¼Œ"å¥¹è§£é‡Šé“ï¼Œé­”æ–ç…§äº®äº†ä¸€æ¡å°æºªã€‚"å®ƒæè¿°äº†æ°´å¦‚ä½•åœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­ä¸æ–­å¾ªç¯æµåŠ¨ã€‚""
      },
      {
        en: "\"First comes evaporation,\" Hermione said, pointing her wand at a puddle. Warm air caused the liquid water to transform into invisible water vapor that rose into the sky. \"The sun acts like a giant heating spell! It gives water molecules enough energy to escape into the atmosphere.\" Ron stared at the puddle shrinking before his eyes. \"It's like magic!\" \"It IS science,\" Hermione corrected with a smile.",
        zh: ""é¦–å…ˆæ˜¯è’¸å‘ï¼Œ"èµ«æ•æŒ‡ç€é­”æ–æœä¸€ä¸ªæ°´å‘è¯´ã€‚æ¸©æš–çš„ç©ºæ°”ä½¿æ¶²æ€æ°´è½¬å˜æˆçœ‹ä¸è§çš„æ°´è’¸æ°”å‡å…¥å¤©ç©ºã€‚"å¤ªé˜³å°±åƒä¸€ä¸ªå·¨å¤§çš„åŠ çƒ­å’’è¯­ï¼å®ƒç»™æ°´åˆ†å­è¶³å¤Ÿçš„èƒ½é‡é€ƒå…¥å¤§æ°”å±‚ã€‚"ç½—æ©ç›¯ç€çœ¼å‰æ…¢æ…¢å˜å°çš„æ°´å‘ã€‚"è¿™å°±åƒé­”æ³•ï¼""è¿™æ˜¯ç§‘å­¦ï¼Œ"èµ«æ•å¾®ç¬‘ç€çº æ­£é“ã€‚"
      },
      {
        en: "\"Next is condensation,\" Hermione continued. \"As water vapor rises higher into the atmosphere, it cools down. Cold air can't hold as much water vapor, so the vapor turns back into tiny liquid droplets â€” and those droplets cluster together to form clouds!\" Above them, grey clouds were gathering over the forest. \"And when clouds get too heavy with water droplets...\" Ron looked up nervously. \"...it rains!\" A crack of thunder confirmed it perfectly.",
        zh: ""æ¥ä¸‹æ¥æ˜¯å‡ç»“ï¼Œ"èµ«æ•ç»§ç»­è¯´ã€‚"æ°´è’¸æ°”åœ¨å¤§æ°”ä¸­ä¸Šå‡æ—¶ä¼šå†·å´ã€‚å†·ç©ºæ°”æ— æ³•å®¹çº³é‚£ä¹ˆå¤šæ°´è’¸æ°”ï¼Œæ‰€ä»¥æ°´è’¸æ°”å˜å›å°æ°´æ»´â€”â€”è¿™äº›å°æ°´æ»´èšé›†åœ¨ä¸€èµ·å½¢æˆäº‘ï¼"ä»–ä»¬å¤´é¡¶ä¸Šï¼Œç°è‰²çš„äº‘æ­£åœ¨æ£®æ—ä¸Šç©ºèšé›†ã€‚"å½“äº‘ä¸­çš„æ°´æ»´å¤ªå¤šå¤ªé‡æ—¶â€¦â€¦"ç½—æ©ç´§å¼ åœ°æŠ¬å¤´çœ‹ã€‚"â€¦â€¦å°±ä¼šä¸‹é›¨ï¼"ä¸€å£°é›·é¸£å®Œç¾åœ°å°è¯äº†è¿™ä¸€ç‚¹ã€‚"
      },
      {
        en: "Hermione pointed to a map she had drawn. \"Canada is divided into provinces and territories. The Forbidden Forest would be like the boreal forest that covers much of northern Canada â€” it plays a huge role in the water cycle by absorbing rain and releasing water vapor through leaves, a process called transpiration.\" Harry looked around with new respect for the ancient trees. Science and geography had just made the forest feel even more magical.",
        zh: "èµ«æ•æŒ‡ç€å¥¹ç”»çš„åœ°å›¾è¯´ã€‚"åŠ æ‹¿å¤§è¢«åˆ’åˆ†æˆçœä»½å’Œé¢†åœ°ã€‚ç¦å¿Œæ£®æ—å°±åƒè¦†ç›–ç€åŠ æ‹¿å¤§å¤§éƒ¨åˆ†åŒ—éƒ¨åœ°åŒºçš„åŒ—æ–¹é’ˆå¶æ—â€”â€”å®ƒé€šè¿‡å¸æ”¶é›¨æ°´å¹¶é€šè¿‡å¶ç‰‡é‡Šæ”¾æ°´è’¸æ°”åœ¨æ°´å¾ªç¯ä¸­å‘æŒ¥ç€å·¨å¤§çš„ä½œç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè’¸è…¾ä½œç”¨ã€‚"å“ˆåˆ©å¸¦ç€æ–°çš„æ•¬æ„ç¯é¡¾é‚£äº›å¤è€çš„å¤§æ ‘ã€‚ç§‘å­¦å’Œåœ°ç†è®©è¿™ç‰‡æ£®æ—æ„Ÿè§‰æ›´åŠ ç¥å¥‡äº†ã€‚"
      }
    ],
    knowledge: [
      {
        subject: 'science', type: 'kc-science',
        titleEn: 'The Water Cycle',
        titleZh: 'æ°´å¾ªç¯',
        explanation: 'The water cycle has 4 main stages: Evaporation (liquid â†’ gas, heated by sun), Condensation (gas â†’ liquid, forms clouds), Precipitation (rain/snow falls), and Collection (water gathers in oceans, lakes, rivers).',
        explanationZh: 'æ°´å¾ªç¯æœ‰å››ä¸ªä¸»è¦é˜¶æ®µï¼šè’¸å‘ï¼ˆæ¶²æ€â†’æ°”æ€ï¼Œè¢«å¤ªé˜³åŠ çƒ­ï¼‰ã€å‡ç»“ï¼ˆæ°”æ€â†’æ¶²æ€ï¼Œå½¢æˆäº‘ï¼‰ã€é™æ°´ï¼ˆé™é›¨/é™é›ªï¼‰å’Œæ±‡é›†ï¼ˆæ°´èšé›†åœ¨æµ·æ´‹ã€æ¹–æ³Šã€æ²³æµä¸­ï¼‰ã€‚',
        magicLink: 'Rain from clouds = precipitation! äº‘ä¸­é™é›¨=é™æ°´ï¼'
      },
      {
        subject: 'social', type: 'kc-social',
        titleEn: 'Canadian Geography',
        titleZh: 'åŠ æ‹¿å¤§åœ°ç†',
        explanation: 'Canada has 10 provinces and 3 territories. The boreal forest (taiga) covers 58% of Canada\'s land area. Major regions include the Great Plains, Canadian Shield, and Rocky Mountains.',
        explanationZh: 'åŠ æ‹¿å¤§æœ‰10ä¸ªçœå’Œ3ä¸ªåœ°åŒºã€‚åŒ—æ–¹é’ˆå¶æ—ï¼ˆæ³°åŠ æ—ï¼‰è¦†ç›–äº†åŠ æ‹¿å¤§58%çš„åœŸåœ°é¢ç§¯ã€‚ä¸»è¦åœ°åŒºåŒ…æ‹¬å¤§å¹³åŸã€åŠ æ‹¿å¤§åœ°ç›¾å’Œè½åŸºå±±è„‰ã€‚',
        magicLink: 'Like mapping magical territories! å°±åƒç»˜åˆ¶é­”æ³•é¢†åœŸåœ°å›¾ï¼'
      },
      {
        subject: 'science', type: 'kc-science',
        titleEn: 'Transpiration in Plants',
        titleZh: 'æ¤ç‰©çš„è’¸è…¾ä½œç”¨',
        explanation: 'Plants absorb water through roots and release water vapor through tiny pores (stomata) in their leaves. This process is called transpiration and contributes to the local water cycle and climate.',
        explanationZh: 'æ¤ç‰©é€šè¿‡æ ¹éƒ¨å¸æ”¶æ°´åˆ†ï¼Œé€šè¿‡å¶ç‰‡ä¸Šçš„å¾®å°æ°”å­”ï¼ˆæ°”å­”ï¼‰é‡Šæ”¾æ°´è’¸æ°”ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºè’¸è…¾ä½œç”¨ï¼Œå¯¹å½“åœ°æ°´å¾ªç¯å’Œæ°”å€™æœ‰è´¡çŒ®ã€‚',
        magicLink: 'Trees are nature\'s weather makers! æ ‘æœ¨æ˜¯å¤§è‡ªç„¶çš„å¤©æ°”åˆ¶é€ è€…ï¼'
      }
    ],
    vocab: ['evaporation', 'condensation', 'precipitation', 'transpiration', 'atmosphere', 'province', 'territory', 'geography'],
    quiz: [
      {
        qEn: "What happens to liquid water during EVAPORATION?",
        qZh: "æ¶²æ€æ°´åœ¨è’¸å‘è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ",
        options: ['It freezes into ice', 'It turns into water vapor (gas)', 'It becomes a cloud', 'It falls as rain'],
        correct: 1,
        feedback: "Correct! Evaporation is when liquid water is heated and turns into water vapor. æ­£ç¡®ï¼è’¸å‘æ˜¯æ¶²æ€æ°´è¢«åŠ çƒ­å˜æˆæ°´è’¸æ°”çš„è¿‡ç¨‹ã€‚"
      },
      {
        qEn: "How many provinces does Canada have?",
        qZh: "åŠ æ‹¿å¤§æœ‰å¤šå°‘ä¸ªçœï¼Ÿ",
        options: ['8', '12', '10', '13'],
        correct: 2,
        feedback: "Right! Canada has 10 provinces and 3 territories, for a total of 13 regions. æ­£ç¡®ï¼åŠ æ‹¿å¤§æœ‰10ä¸ªçœå’Œ3ä¸ªåœ°åŒºï¼Œå…±13ä¸ªåŒºåŸŸã€‚"
      },
      {
        qEn: "What is it called when water vapor cools and forms clouds?",
        qZh: "æ°´è’¸æ°”å†·å´å½¢æˆäº‘çš„è¿‡ç¨‹å«ä»€ä¹ˆï¼Ÿ",
        options: ['Evaporation', 'Precipitation', 'Condensation', 'Transpiration'],
        correct: 2,
        feedback: "Excellent! Condensation occurs when water vapor cools and turns into liquid water droplets that form clouds. å¤ªæ£’äº†ï¼å‡ç»“æ˜¯æ°´è’¸æ°”å†·å´å˜æˆæ¶²æ€æ°´æ»´å½¢æˆäº‘çš„è¿‡ç¨‹ã€‚"
      },
      {
        qEn: "What is the process called when plants release water vapor through their leaves?",
        qZh: "æ¤ç‰©é€šè¿‡å¶ç‰‡é‡Šæ”¾æ°´è’¸æ°”çš„è¿‡ç¨‹å«ä»€ä¹ˆï¼Ÿ",
        options: ['Evaporation', 'Transpiration', 'Respiration', 'Condensation'],
        correct: 1,
        feedback: "Brilliant! Transpiration is plants' contribution to the water cycle. å¤ªèªæ˜äº†ï¼è’¸è…¾ä½œç”¨æ˜¯æ¤ç‰©å¯¹æ°´å¾ªç¯çš„è´¡çŒ®ã€‚"
      },
      {
        qEn: "In the water cycle, what causes water to evaporate from oceans and lakes?",
        qZh: "åœ¨æ°´å¾ªç¯ä¸­ï¼Œæ˜¯ä»€ä¹ˆå¯¼è‡´æµ·æ´‹å’Œæ¹–æ³Šä¸­çš„æ°´è’¸å‘ï¼Ÿ",
        options: ['The moon', 'Wind', 'The sun\'s heat', 'Cold air'],
        correct: 2,
        feedback: "Correct! The sun provides the energy needed for evaporation. æ­£ç¡®ï¼å¤ªé˜³æä¾›è’¸å‘æ‰€éœ€çš„èƒ½é‡ã€‚"
      }
    ]
  },
  {
    day: 3,
    titleEn: "Ron's Adventures with Time and Money at Diagon Alley",
    titleZh: "ç½—æ©åœ¨å¯¹è§’å··çš„æ—¶é—´ä¸é‡‘é’±å†’é™©",
    subjects: ['math', 'social'],
    scene: {
      emojis: [
        {e:'ğŸª',x:'50%',y:'40%',main:true},
        {e:'ğŸª™',x:'25%',y:'60%'},{e:'â°',x:'75%',y:'55%'},
        {e:'ğŸ“Š',x:'35%',y:'30%'},{e:'ğŸ›ï¸',x:'65%',y:'65%'}
      ],
      bg: 'linear-gradient(135deg, #1a0a00 0%, #2a1a0a 40%, #0a0a1a 100%)'
    },
    paragraphs: [
      {
        en: "It was a busy Saturday at Diagon Alley, the magical shopping street. Ron Weasley had been given 20 Galleons to buy his school supplies. \"A Galleon is the wizarding currency,\" he explained to Muggle-born Hermione. \"Just like Canada uses dollars and cents, we use Galleons, Sickles, and Knuts. There are 17 Sickles in a Galleon and 29 Knuts in a Sickle!\" Managing money required real math skills.",
        zh: "è¿™æ˜¯å¯¹è§’å··è¿™æ¡é­”æ³•è´­ç‰©è¡—å¿™ç¢Œçš„å‘¨å…­ã€‚ç½—æ©Â·éŸ¦æ–¯è±æ”¶åˆ°äº†20åŠ éš†æ¥è´­ä¹°å­¦æ ¡ç”¨å“ã€‚"åŠ éš†æ˜¯å·«å¸ˆç•Œçš„è´§å¸ï¼Œ"ä»–å‘éº»ç“œå‡ºèº«çš„èµ«æ•è§£é‡Šã€‚"å°±åƒåŠ æ‹¿å¤§ç”¨ç¾å…ƒå’Œåˆ†ï¼Œæˆ‘ä»¬ç”¨åŠ éš†ã€è¥¿å¯å’Œç§‘çº³ç‰¹ã€‚1åŠ éš†ç­‰äº17è¥¿å¯ï¼Œ1è¥¿å¯ç­‰äº29ç§‘çº³ç‰¹ï¼"ç®¡ç†é’±éœ€è¦çœŸæ­£çš„æ•°å­¦æŠ€èƒ½ã€‚"
      },
      {
        en: "Ron made a budget â€” a plan for spending his money. His list: spellbooks cost 8 Galleons, potion ingredients 5 Galleons, and a new quill set 3 Galleons. He used addition: 8 + 5 + 3 = 16 Galleons total. \"I'll have 20 - 16 = 4 Galleons left over!\" he calculated proudly. Budgeting meant making sure you didn't spend more than you had â€” an important life skill in both the wizarding and Muggle worlds.",
        zh: "ç½—æ©åˆ¶å®šäº†ä¸€ä¸ªé¢„ç®—â€”â€”èŠ±é’±è®¡åˆ’ã€‚ä»–çš„æ¸…å•ï¼šé­”æ³•ä¹¦8åŠ éš†ï¼Œé­”è¯åŸæ–™5åŠ éš†ï¼Œæ–°ç¾½æ¯›ç¬”å¥—è£…3åŠ éš†ã€‚ä»–ç”¨åŠ æ³•è®¡ç®—ï¼š8 + 5 + 3 = 16åŠ éš†ã€‚"æˆ‘è¿˜å‰©20 - 16 = 4åŠ éš†ï¼"ä»–éª„å‚²åœ°ç®—å‡ºæ¥ã€‚é¢„ç®—æ„å‘³ç€ç¡®ä¿èŠ±è´¹ä¸è¶…è¿‡æ‹¥æœ‰çš„â€”â€”è¿™æ˜¯å·«å¸ˆä¸–ç•Œå’Œéº»ç“œä¸–ç•Œéƒ½å¾ˆé‡è¦çš„ç”Ÿæ´»æŠ€èƒ½ã€‚"
      },
      {
        en: "At Madam Malkin's robe shop, Ron noticed a sign: \"Grand Sale! 25% OFF all robes.\" The robes he wanted cost 8 Galleons normally. \"How much is 25% off?\" he wondered. Hermione pulled out parchment: 25% means 25 out of 100, or Â¼. So Â¼ of 8 = 2 Galleons off. The sale price would be 8 - 2 = 6 Galleons. \"Percentages are just fractions in disguise,\" Hermione explained.",
        zh: "åœ¨é©¬å°”é‡‘å¤«äººçš„é•¿è¢åº—ï¼Œç½—æ©çœ‹åˆ°ä¸€ä¸ªç‰Œå­ï¼š"ç››å¤§ä¿ƒé”€ï¼æ‰€æœ‰é•¿è¢7.5æŠ˜ä¼˜æƒ ã€‚"ä»–æƒ³è¦çš„é•¿è¢é€šå¸¸è¦8åŠ éš†ã€‚"7.5æŠ˜æ˜¯å¤šå°‘é’±ï¼Ÿ"ä»–çº³é—·é“ã€‚èµ«æ•æ‹¿å‡ºç¾Šçš®çº¸ï¼š25%æ„å‘³ç€100ä¸­çš„25ï¼Œå³Â¼ã€‚æ‰€ä»¥Â¼çš„8 = 2åŠ éš†çš„æŠ˜æ‰£ã€‚ç‰¹ä»·æ˜¯8 - 2 = 6åŠ éš†ã€‚"ç™¾åˆ†æ¯”åªæ˜¯åˆ†æ•°çš„å¦ä¸€ç§å½¢å¼ï¼Œ"èµ«æ•è§£é‡Šé“ã€‚"
      },
      {
        en: "As afternoon turned to evening, Ron checked his pocket watch. \"We arrived at 10:30 AM and it's now 2:45 PM. How long have we been shopping?\" They counted: from 10:30 to 2:30 is 4 hours, plus 15 more minutes = 4 hours and 15 minutes! \"Time is like a number line,\" said Hermione. \"Canada even has multiple time zones â€” like how Toronto is 3 hours ahead of Vancouver!\" Understanding time helped them plan their whole day.",
        zh: "ä¸‹åˆæ…¢æ…¢å˜æˆå‚æ™šï¼Œç½—æ©æŸ¥çœ‹ä»–çš„æ€€è¡¨ã€‚"æˆ‘ä»¬ä¸Šåˆ10:30åˆ°è¾¾ï¼Œç°åœ¨æ˜¯ä¸‹åˆ2:45ã€‚æˆ‘ä»¬è´­ç‰©äº†å¤šä¹…ï¼Ÿ"ä»–ä»¬è®¡ç®—ï¼šä»10:30åˆ°2:30æ˜¯4å°æ—¶ï¼Œå†åŠ 15åˆ†é’Ÿ = 4å°æ—¶15åˆ†é’Ÿï¼"æ—¶é—´å°±åƒä¸€æ¡æ•°è½´ï¼Œ"èµ«æ•è¯´ã€‚"åŠ æ‹¿å¤§ç”šè‡³æœ‰å¤šä¸ªæ—¶åŒºâ€”â€”æ¯”å¦‚å¤šä¼¦å¤šæ¯”æ¸©å“¥åæ—©3å°æ—¶ï¼"ç†è§£æ—¶é—´å¸®åŠ©ä»–ä»¬è§„åˆ’æ•´å¤©çš„è¡Œç¨‹ã€‚"
      }
    ],
    knowledge: [
      {
        subject: 'math', type: 'kc-math',
        titleEn: 'Percentages',
        titleZh: 'ç™¾åˆ†æ¯”',
        explanation: 'A percentage is a fraction out of 100. "Per cent" means "per hundred." 25% = 25/100 = 1/4. To find 25% of a number, divide by 4. To find 50%, divide by 2. To find 10%, divide by 10.',
        explanationZh: 'ç™¾åˆ†æ¯”æ˜¯100ä¸­çš„ä¸€éƒ¨åˆ†ã€‚"ç™¾åˆ†"æ„æ€æ˜¯"æ¯ç™¾ä¸ªä¸­çš„"ã€‚25% = 25/100 = 1/4ã€‚è¦æ±‚ä¸€ä¸ªæ•°çš„25%ï¼Œé™¤ä»¥4ã€‚è¦æ±‚50%ï¼Œé™¤ä»¥2ã€‚è¦æ±‚10%ï¼Œé™¤ä»¥10ã€‚',
        magicLink: 'Sale prices use percentages! æ‰“æŠ˜ä»·æ ¼ä½¿ç”¨ç™¾åˆ†æ¯”ï¼'
      },
      {
        subject: 'math', type: 'kc-math',
        titleEn: 'Elapsed Time',
        titleZh: 'ç»è¿‡æ—¶é—´',
        explanation: 'Elapsed time is how much time has passed between a start time and end time. Count forward from the start time. Example: 10:30 AM to 2:45 PM = 4 hours 15 minutes. Break it into hours first, then minutes.',
        explanationZh: 'ç»è¿‡æ—¶é—´æ˜¯å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ä¹‹é—´ç»è¿‡äº†å¤šå°‘æ—¶é—´ã€‚ä»å¼€å§‹æ—¶é—´å¾€åæ•°ã€‚ä¾‹å¦‚ï¼šä¸Šåˆ10:30åˆ°ä¸‹åˆ2:45 = 4å°æ—¶15åˆ†é’Ÿã€‚å…ˆè®¡ç®—å°æ—¶ï¼Œå†è®¡ç®—åˆ†é’Ÿã€‚',
        magicLink: 'How long is Defense Against the Dark Arts? é»‘é­”æ³•é˜²å¾¡è¯¾æœ‰å¤šé•¿ï¼Ÿ'
      },
      {
        subject: 'social', type: 'kc-social',
        titleEn: 'Canadian Economy',
        titleZh: 'åŠ æ‹¿å¤§ç»æµ',
        explanation: 'Canada uses the Canadian dollar (CAD). Canada is a market economy where businesses sell goods and services. Key industries include natural resources, manufacturing, and services. Canada trades mainly with the USA.',
        explanationZh: 'åŠ æ‹¿å¤§ä½¿ç”¨åŠ å…ƒï¼ˆCADï¼‰ã€‚åŠ æ‹¿å¤§æ˜¯ä¸€ä¸ªå¸‚åœºç»æµä½“ï¼Œä¼ä¸šå‡ºå”®å•†å“å’ŒæœåŠ¡ã€‚ä¸»è¦è¡Œä¸šåŒ…æ‹¬è‡ªç„¶èµ„æºã€åˆ¶é€ ä¸šå’ŒæœåŠ¡ä¸šã€‚åŠ æ‹¿å¤§ä¸»è¦ä¸ç¾å›½è¿›è¡Œè´¸æ˜“ã€‚',
        magicLink: 'Like Galleons in the magical world! å°±åƒé­”æ³•ä¸–ç•Œçš„åŠ éš†ï¼'
      }
    ],
    vocab: ['percentage', 'budget', 'currency', 'elapsed', 'discount', 'economy', 'territory', 'calculate'],
    quiz: [
      {
        qEn: "Ron spent 8 + 5 + 3 Galleons. How much did he spend in total?",
        qZh: "ç½—æ©èŠ±äº†8 + 5 + 3åŠ éš†ã€‚ä»–æ€»å…±èŠ±äº†å¤šå°‘ï¼Ÿ",
        options: ['14 Galleons', '16 Galleons', '18 Galleons', '15 Galleons'],
        correct: 1,
        feedback: "Correct! 8 + 5 + 3 = 16 Galleons. æ­£ç¡®ï¼8 + 5 + 3 = 16åŠ éš†ã€‚"
      },
      {
        qEn: "The robes cost 8 Galleons with 25% off. How much is the discount?",
        qZh: "é•¿è¢åŸä»·8åŠ éš†ï¼Œæ‰“25%æŠ˜æ‰£ã€‚æŠ˜æ‰£æ˜¯å¤šå°‘ï¼Ÿ",
        options: ['1 Galleon', '3 Galleons', '2 Galleons', '4 Galleons'],
        correct: 2,
        feedback: "Right! 25% of 8 = 8 Ã· 4 = 2 Galleons discount. æ­£ç¡®ï¼8çš„25% = 8 Ã· 4 = 2åŠ éš†æŠ˜æ‰£ã€‚"
      },
      {
        qEn: "They arrived at 10:30 AM and left at 2:45 PM. How long did they shop?",
        qZh: "ä»–ä»¬ä¸Šåˆ10:30åˆ°è¾¾ï¼Œä¸‹åˆ2:45ç¦»å¼€ã€‚ä»–ä»¬è´­ç‰©äº†å¤šä¹…ï¼Ÿ",
        options: ['3 hours 15 min', '4 hours 15 min', '4 hours 30 min', '3 hours 45 min'],
        correct: 1,
        feedback: "Excellent! 10:30 to 2:30 = 4 hours, plus 15 min = 4 hours 15 minutes. å¤ªæ£’äº†ï¼10:30åˆ°2:30 = 4å°æ—¶ï¼ŒåŠ 15åˆ†é’Ÿ = 4å°æ—¶15åˆ†é’Ÿã€‚"
      },
      {
        qEn: "What currency does Canada use?",
        qZh: "åŠ æ‹¿å¤§ä½¿ç”¨ä»€ä¹ˆè´§å¸ï¼Ÿ",
        options: ['US Dollar', 'Euro', 'Canadian Dollar', 'Pound'],
        correct: 2,
        feedback: "Correct! Canada uses the Canadian Dollar (CAD). æ­£ç¡®ï¼åŠ æ‹¿å¤§ä½¿ç”¨åŠ å…ƒï¼ˆCADï¼‰ã€‚"
      },
      {
        qEn: "50% is the same as which fraction?",
        qZh: "50%ç­‰äºå“ªä¸ªåˆ†æ•°ï¼Ÿ",
        options: ['1/4', '1/3', '3/4', '1/2'],
        correct: 3,
        feedback: "Well done! 50% = 50/100 = 1/2. Half! åšå¾—å¥½ï¼50% = 50/100 = 1/2ã€‚ä¸€åŠï¼"
      }
    ]
  }
];

// Get today's story (rotate by day of year)
function getTodayStory() {
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
  return STORIES[dayOfYear % STORIES.length];
}

// ============================================================
// STATE
// ============================================================
let state = {
  character: null,
  points: 0,
  housePoints: { gryffindor: 0, hufflepuff: 0, ravenclaw: 0, slytherin: 0 },
  achievements: [],
  earnedAchievements: [],
  completedDays: [],
  streak: 0,
  storiesRead: 0,
  quizzesCompleted: 0,
  wordsMastered: 0,
  dictationHistory: [],
  quizHistory: []
};

const CHARACTERS = {
  harry:    { avatar:'âš¡', nameEn:'Harry Potter', nameZh:'å“ˆåˆ©Â·æ³¢ç‰¹', house:'gryffindor', houseZh:'æ ¼å…°èŠ¬å¤š' },
  hermione: { avatar:'ğŸ“š', nameEn:'Hermione Granger', nameZh:'èµ«æ•Â·æ ¼å…°æ°', house:'gryffindor', houseZh:'æ ¼å…°èŠ¬å¤š' },
  ron:      { avatar:'ğŸ®', nameEn:'Ron Weasley', nameZh:'ç½—æ©Â·éŸ¦æ–¯è±', house:'gryffindor', houseZh:'æ ¼å…°èŠ¬å¤š' },
  neville:  { avatar:'ğŸŒ¿', nameEn:'Neville Longbottom', nameZh:'çº³å¨Â·éš†å·´é¡¿', house:'hufflepuff', houseZh:'èµ«å¥‡å¸•å¥‡' },
  luna:     { avatar:'ğŸŒ™', nameEn:'Luna Lovegood', nameZh:'å¢å¨œÂ·æ´›å¤«å¤å¾·', house:'ravenclaw', houseZh:'æ‹‰æ–‡å…‹åŠ³' },
  draco:    { avatar:'ğŸ', nameEn:'Draco Malfoy', nameZh:'å¾·æ‹‰ç§‘Â·é©¬å°”ç¦', house:'slytherin', houseZh:'æ–¯è±ç‰¹æ—' }
};

const ACHIEVEMENTS_DEF = [
  { id:'first_story', icon:'ğŸ“–', name:'åˆè¯»è€…', desc:'Read your first story', pts:50, earned:false },
  { id:'first_quiz', icon:'ğŸ§ ', name:'æµ‹éªŒæ–°æ‰‹', desc:'Complete first quiz', pts:50, earned:false },
  { id:'perfect_quiz', icon:'ğŸ’«', name:'å®Œç¾ç­”å·', desc:'Score 100% on a quiz', pts:100, earned:false },
  { id:'first_dictation', icon:'âœï¸', name:'å¬å†™è§ä¹ ', desc:'Complete first dictation', pts:50, earned:false },
  { id:'streak_3', icon:'ğŸ”¥', name:'ä¸‰æ—¥è¿ç»­', desc:'3 day learning streak', pts:150, earned:false },
  { id:'streak_7', icon:'âš¡', name:'ä¸€å‘¨è¿ç»­', desc:'7 day learning streak', pts:300, earned:false },
  { id:'points_100', icon:'â­', name:'ç™¾ç‚¹å·«å¸ˆ', desc:'Earn 100 points', pts:0, earned:false },
  { id:'points_500', icon:'ğŸŒŸ', name:'äº”ç™¾ç‚¹æ³•å¸ˆ', desc:'Earn 500 points', pts:0, earned:false },
  { id:'words_20', icon:'ğŸ“', name:'è¯æ±‡å­¦è€…', desc:'Master 20 words', pts:100, earned:false },
  { id:'quizzes_5', icon:'ğŸ…', name:'æµ‹éªŒè¾¾äºº', desc:'Complete 5 quizzes', pts:200, earned:false },
  { id:'gryffindor', icon:'ğŸ¦', name:'æ ¼å…°èŠ¬å¤šå‹‡å£«', desc:'Choose Gryffindor house', pts:30, earned:false },
  { id:'ravenclaw', icon:'ğŸ¦…', name:'æ‹‰æ–‡å…‹åŠ³æ™ºè€…', desc:'Choose Ravenclaw house', pts:30, earned:false },
];

const HOUSE_COLORS = {
  gryffindor: '#ae1212',
  hufflepuff: '#f0c040',
  ravenclaw: '#4a90d9',
  slytherin: '#1a472a'
};

// ============================================================
// INIT
// ============================================================
function init() {
  try { loadState(); } catch(e) { console.warn('loadState:', e); }
  try { createStars(); } catch(e) { console.warn('createStars:', e); }
  try { createParticles(); } catch(e) { console.warn('createParticles:', e); }

  function revealApp() {
    try {
      document.getElementById('loading-screen').style.display = 'none';
      if (state.character && CHARACTERS[state.character]) {
        showMain();
      } else {
        state.character = null;
        document.getElementById('screen-character').classList.add('active');
      }
    } catch(e) {
      console.error('revealApp error:', e);
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('screen-character').classList.add('active');
    }
  }

  setTimeout(revealApp, 800);
}

function loadState() {
  const saved = localStorage.getItem('wizard-academy-state');
  if (saved) {
    try { state = { ...state, ...JSON.parse(saved) }; } catch(e) {}
  }
}

function saveState() {
  localStorage.setItem('wizard-academy-state', JSON.stringify(state));
}

function createStars() {
  const bg = document.getElementById('stars-bg');
  for (let i = 0; i < 120; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2.5 + 0.5;
    s.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%; top:${Math.random()*100}%;
      --dur:${2+Math.random()*4}s; --delay:${Math.random()*5}s;
    `;
    bg.appendChild(s);
  }
}

function createParticles() {
  const emojis = ['âœ¨','â­','ğŸŒŸ','ğŸ’«','ğŸª„','âš¡','ğŸ”®'];
  for (let i = 0; i < 15; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    p.style.cssText = `
      left:${Math.random()*100}%;
      --dur:${8+Math.random()*10}s;
      --delay:${Math.random()*10}s;
      --size:${10+Math.random()*14}px;
    `;
    document.body.appendChild(p);
  }
}

// ============================================================
// CHARACTER SELECT
// ============================================================
function selectCharacter(id, avatar, nameEn, nameZh, house, trait) {
  state.character = id;
  const char = CHARACTERS[id];
  state.housePoints[char.house] = (state.housePoints[char.house] || 0) + 30;
  
  // Check house achievement
  if (!state.earnedAchievements?.includes(char.house)) {
    state.earnedAchievements = state.earnedAchievements || [];
    state.earnedAchievements.push(char.house);
    addPoints(30, 'Joined ' + house + '!');
  }

  saveState();
  showMain();
}

function goToCharacterSelect() {
  document.getElementById('screen-main').classList.remove('active');
  document.getElementById('screen-character').classList.add('active');
}

// ============================================================
// MAIN APP
// ============================================================
function showMain() {
  try {
  document.getElementById('screen-character').classList.remove('active');
  document.getElementById('screen-main').classList.add('active');

  const char = CHARACTERS[state.character];
  if (!char) { state.character = null; document.getElementById('screen-character').classList.add('active'); return; }
  document.getElementById('header-avatar').textContent = char.avatar;
  document.getElementById('header-name').textContent = char.nameEn;
  document.getElementById('header-house').textContent = char.houseZh;
  document.getElementById('total-points').textContent = state.points;

  const today = new Date();
  const dayNum = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
  document.getElementById('day-num').textContent = dayNum;

  loadStory();
  buildAchievements();
  buildCalendar();
  buildHouseCup();
  updateStats();
  } catch(e) { console.error("showMain error:", e); }
}

// ============================================================
// STORY
// ============================================================
const currentStory = getTodayStory();
let speechSynth = window.speechSynthesis;
let currentUtterance = null;
let isReadingAll = false;
let paraMode = false;
let speechRate = 1.0;

function loadStory() {
  const story = currentStory;

  // Date
  const now = new Date();
  document.getElementById('story-date-display').textContent =
    now.toLocaleDateString('en-CA', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  document.getElementById('story-title-en').textContent = story.titleEn;
  document.getElementById('story-title-zh').textContent = story.titleZh;

  // Tags
  const tagMap = {
    math: {label:'æ•°å­¦ Math', cls:'tag-math'},
    science: {label:'ç§‘å­¦ Science', cls:'tag-science'},
    social: {label:'ç¤¾ä¼š Social', cls:'tag-social'},
    english: {label:'è‹±è¯­ English', cls:'tag-english'}
  };
  const tagsEl = document.getElementById('story-tags');
  tagsEl.innerHTML = story.subjects.map(s =>
    `<span class="subject-tag ${tagMap[s].cls}">${tagMap[s].label}</span>`
  ).join('');

  // Scene
  buildScene(story.scene);

  // Paragraphs
  const body = document.getElementById('story-body');
  body.innerHTML = story.paragraphs.map((p, i) => `
    <div class="story-paragraph" id="para-${i}" onclick="readParagraph(${i})">
      <div class="para-en">${p.en.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>
      <div class="para-zh">${p.zh}</div>
    </div>
  `).join('');

  // Inline knowledge cards
  buildKnowledgeCards('inline-knowledge-cards', story.knowledge);
  buildKnowledgeCards('knowledge-cards-full', story.knowledge);

  // Word list for dictation
  buildWordList(story.vocab);

  // Quiz
  buildQuiz(story.quiz);

  // Mark as read
  if (!state.completedDays?.includes(story.day)) {
    state.completedDays = state.completedDays || [];
    state.completedDays.push(story.day);
    state.storiesRead = (state.storiesRead || 0) + 1;
    addPoints(20, '+20 æ•…äº‹é˜…è¯»ï¼');
    checkAchievement('first_story');
    saveState();
  }
}

function buildScene(scene) {
  const sceneEl = document.getElementById('story-scene');
  sceneEl.style.background = scene.bg;
  sceneEl.innerHTML = '';

  scene.emojis.forEach((e, i) => {
    const el = document.createElement('div');
    el.className = 'magic-particle';
    const tx = (Math.random()-0.5)*60;
    const ty = -(20 + Math.random()*40);
    el.style.cssText = `
      left:${e.x}; top:${e.y};
      font-size:${e.main ? '56px' : '28px'};
      --d:${3+Math.random()*3}s;
      --dl:${Math.random()*3}s;
      --tx:${tx}px; --ty:${ty}px;
      filter: drop-shadow(0 0 8px rgba(245,197,24,0.6));
    `;
    el.textContent = e.e;
    sceneEl.appendChild(el);
  });
}

function buildKnowledgeCards(containerId, knowledge) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = knowledge.map(k => `
    <div class="knowledge-card ${k.type}" onclick="speakText('${encodeURIComponent(k.titleEn + '. ' + k.explanation)}')">
      <div class="kc-subject">${k.subject.toUpperCase()}</div>
      <div class="kc-title">${k.titleEn}</div>
      <div class="kc-title-zh">${k.titleZh}</div>
      <div class="kc-explanation">${k.explanation}</div>
      <div class="kc-explanation-zh">${k.explanationZh}</div>
      <div style="margin-top:10px;font-size:11px;color:rgba(245,197,24,0.7);font-style:italic;">âš¡ ${k.magicLink}</div>
    </div>
  `).join('');
}

// ============================================================
// SPEECH
// ============================================================
function speakText(encoded) {
  stopSpeech();
  const text = decodeURIComponent(encoded);
  currentUtterance = new SpeechSynthesisUtterance(text);
  currentUtterance.rate = speechRate;
  currentUtterance.lang = 'en-US';
  speechSynth.speak(currentUtterance);
}

function readParagraph(i) {
  stopSpeech();
  document.querySelectorAll('.story-paragraph').forEach(p => p.classList.remove('reading', 'highlighted'));
  const paraEl = document.getElementById('para-' + i);
  paraEl.classList.add('reading');

  const text = currentStory.paragraphs[i].en;
  currentUtterance = new SpeechSynthesisUtterance(text);
  currentUtterance.rate = speechRate;
  currentUtterance.lang = 'en-US';
  currentUtterance.onend = () => {
    paraEl.classList.remove('reading');
    paraEl.classList.add('highlighted');
    if (paraMode) {
      const next = i + 1;
      if (next < currentStory.paragraphs.length) {
        setTimeout(() => readParagraph(next), 500);
      }
    }
  };
  speechSynth.speak(currentUtterance);
}

function toggleReadAll() {
  if (isReadingAll) {
    stopSpeech();
    isReadingAll = false;
    document.getElementById('btn-read-all').classList.remove('playing');
    document.getElementById('btn-read-all').textContent = 'ğŸ”Š æœ—è¯»å…¨æ–‡';
  } else {
    isReadingAll = true;
    paraMode = false;
    document.getElementById('btn-read-all').classList.add('playing');
    document.getElementById('btn-read-all').innerHTML = 'â¸ æš‚åœæœ—è¯»';
    readAllParas(0);
  }
}

function readAllParas(i) {
  if (!isReadingAll || i >= currentStory.paragraphs.length) {
    isReadingAll = false;
    document.getElementById('btn-read-all').classList.remove('playing');
    document.getElementById('btn-read-all').textContent = 'ğŸ”Š æœ—è¯»å…¨æ–‡';
    return;
  }
  document.querySelectorAll('.story-paragraph').forEach(p => p.classList.remove('reading'));
  document.getElementById('para-' + i).classList.add('reading');
  currentUtterance = new SpeechSynthesisUtterance(currentStory.paragraphs[i].en);
  currentUtterance.rate = speechRate;
  currentUtterance.lang = 'en-US';
  currentUtterance.onend = () => {
    document.getElementById('para-' + i)?.classList.remove('reading');
    if (isReadingAll) readAllParas(i + 1);
  };
  speechSynth.speak(currentUtterance);
}

function toggleParaMode() {
  paraMode = !paraMode;
  const btn = document.getElementById('btn-para-read');
  btn.classList.toggle('active', paraMode);
  btn.textContent = paraMode ? 'ğŸ“ æ®µè½æ¨¡å¼ ON' : 'ğŸ“ æ®µè½æ¨¡å¼';
}

function stopSpeech() {
  speechSynth.cancel();
  isReadingAll = false;
  document.querySelectorAll('.story-paragraph').forEach(p => p.classList.remove('reading'));
  document.getElementById('btn-read-all').classList.remove('playing');
  document.getElementById('btn-read-all').textContent = 'ğŸ”Š æœ—è¯»å…¨æ–‡';
}

function updateSpeed() {
  speechRate = parseFloat(document.getElementById('speed-select').value);
}

// ============================================================
// QUIZ
// ============================================================
let quizState = { questions:[], current:0, score:0, answers:[] };

function buildQuiz(questions) {
  quizState.questions = questions;
}

function startQuiz() {
  quizState.current = 0;
  quizState.score = 0;
  quizState.answers = [];
  document.getElementById('quiz-intro').style.display = 'none';
  document.getElementById('quiz-done').style.display = 'none';
  document.getElementById('quiz-active').style.display = 'block';
  showQuestion();
}

function showQuestion() {
  const q = quizState.questions[quizState.current];
  const total = quizState.questions.length;
  const cur = quizState.current + 1;

  document.getElementById('quiz-num').textContent = `Question ${cur} / ${total} Â· ç¬¬${cur}é¢˜`;
  document.getElementById('quiz-progress').style.width = (cur/total*100) + '%';
  document.getElementById('quiz-q-en').textContent = q.qEn;
  document.getElementById('quiz-q-zh').textContent = q.qZh;

  const opts = document.getElementById('quiz-options');
  const letters = ['A','B','C','D'];
  opts.innerHTML = q.options.map((o,i) => `
    <button class="quiz-option" onclick="selectOption(${i})">
      <span class="option-letter">${letters[i]}</span>
      ${o}
    </button>
  `).join('');

  document.getElementById('quiz-feedback').className = 'quiz-feedback';
  document.getElementById('quiz-feedback').textContent = '';
  document.getElementById('quiz-next').className = 'quiz-next-btn';
}

function selectOption(idx) {
  const q = quizState.questions[quizState.current];
  const opts = document.querySelectorAll('.quiz-option');
  opts.forEach(o => o.classList.add('disabled'));

  const isCorrect = idx === q.correct;
  opts[idx].classList.add(isCorrect ? 'correct' : 'wrong');
  if (!isCorrect) opts[q.correct].classList.add('correct');

  const feedback = document.getElementById('quiz-feedback');
  feedback.className = 'quiz-feedback show ' + (isCorrect ? 'correct' : 'wrong');
  feedback.innerHTML = (isCorrect ? 'âœ… ' : 'âŒ ') + q.feedback;

  if (isCorrect) {
    quizState.score++;
    addPoints(10, '+10 â­ ç­”å¯¹äº†ï¼');
  }

  quizState.answers.push({ correct: isCorrect, chosen: idx });
  document.getElementById('quiz-next').className = 'quiz-next-btn show';

  const nextBtn = document.getElementById('quiz-next');
  nextBtn.textContent = quizState.current < quizState.questions.length - 1
    ? 'ä¸‹ä¸€é¢˜ Â· Next â†’'
    : 'æŸ¥çœ‹ç»“æœ Â· Results ğŸ†';
}

function nextQuestion() {
  quizState.current++;
  if (quizState.current >= quizState.questions.length) {
    showQuizResults();
  } else {
    showQuestion();
  }
}

function showQuizResults() {
  document.getElementById('quiz-active').style.display = 'none';
  document.getElementById('quiz-done').style.display = 'block';

  const score = quizState.score;
  const total = quizState.questions.length;
  const pct = Math.round(score/total*100);

  const emojis = ['ğŸ˜¢','ğŸ˜”','ğŸ˜Š','ğŸŒŸ','ğŸ†'];
  const ei = score === 0 ? 0 : score <= 1 ? 1 : score <= 3 ? 2 : score < total ? 3 : 4;
  document.getElementById('quiz-result-emoji').textContent = emojis[ei];
  document.getElementById('quiz-result-score').textContent = `${score}/${total}`;

  const msgs = [
    'å†è¯•ä¸€æ¬¡ï¼Œä½ èƒ½åšåˆ°çš„ï¼Try again, you can do it!',
    'ç»§ç»­åŠ æ²¹ï¼Œè¶Šæ¥è¶Šå¥½ï¼Keep going, getting better!',
    'åšå¾—ä¸é”™ï¼Good job!',
    'å¤ªå‰å®³äº†ï¼Almost perfect!',
    'å®Œç¾ï¼æ»¡åˆ†å·«å¸ˆï¼Perfect! Full marks wizard!'
  ];
  document.getElementById('quiz-result-msg').textContent = msgs[ei];

  state.quizzesCompleted = (state.quizzesCompleted || 0) + 1;
  addPoints(pct === 100 ? 30 : 15, `æµ‹éªŒå®Œæˆ +${pct === 100 ? 30 : 15}åˆ†`);
  if (pct === 100) checkAchievement('perfect_quiz');
  checkAchievement('first_quiz');
  if (state.quizzesCompleted >= 5) checkAchievement('quizzes_5');
  saveState();
  updateStats();
}

// ============================================================
// DICTATION
// ============================================================
let dictMode = 'word';
let dictWords = [];
let dictCurrent = 0;
let dictScore = 0;
let dictTotal = 0;
let dictResults = [];
let selectedWords = [];

function buildWordList(vocab) {
  selectedWords = [...vocab];
  const wl = document.getElementById('word-list');
  wl.innerHTML = vocab.map(w => `
    <div class="word-chip selected" onclick="toggleWord(this,'${w}')" data-word="${w}">${w}</div>
  `).join('');
}

function toggleWord(el, word) {
  el.classList.toggle('selected');
  if (el.classList.contains('selected')) {
    if (!selectedWords.includes(word)) selectedWords.push(word);
  } else {
    selectedWords = selectedWords.filter(w => w !== word);
  }
}

function selectMode(el, mode) {
  dictMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function startDictation() {
  if (selectedWords.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•è¯ï¼'); return; }

  dictWords = [...selectedWords].sort(() => Math.random() - 0.5);
  dictCurrent = 0;
  dictScore = 0;
  dictTotal = dictWords.length;
  dictResults = [];

  document.getElementById('dictation-setup').style.display = 'none';
  document.getElementById('dictation-active').classList.add('show');
  document.getElementById('dictation-results').classList.remove('show');
  document.getElementById('dict-total').textContent = dictTotal;

  const hintMap = { word:'å¬éŸ³å†™è¯', sentence:'å¥å­å¡«ç©º', spell:'æ‹¼å†™æŒ‘æˆ˜' };
  document.getElementById('dict-mode-hint').textContent = `${hintMap[dictMode]} Â· æŒ‰å›è½¦ç¡®è®¤`;

  showDictWord();
}

function showDictWord() {
  if (dictCurrent >= dictTotal) { showDictResults(); return; }

  const word = dictWords[dictCurrent];
  document.getElementById('dict-current').textContent = dictCurrent + 1;
  document.getElementById('dict-progress').style.width = (dictCurrent/dictTotal*100) + '%';
  document.getElementById('dict-input').value = '';
  document.getElementById('dict-input').className = 'dictation-input';
  document.getElementById('dict-input').focus();

  if (dictMode === 'spell') {
    document.getElementById('dict-prompt').textContent = 'ğŸ”¤ ' + '_ '.repeat(word.length);
    document.getElementById('dict-hint').textContent = `${word.length} letters Â· ${word.length}ä¸ªå­—æ¯`;
  } else {
    document.getElementById('dict-prompt').textContent = 'ğŸ”Š';
    document.getElementById('dict-hint').textContent = `Listen carefully Â· ä»”ç»†å¬`;
  }

  setTimeout(() => speakWordAudio(word), 300);
}

function speakWordAudio(word) {
  stopSpeech();
  const utt = new SpeechSynthesisUtterance(word);
  utt.rate = 0.8;
  utt.lang = 'en-US';
  speechSynth.speak(utt);
}

function replayWord() {
  speakWordAudio(dictWords[dictCurrent]);
}

function showHint() {
  const word = dictWords[dictCurrent];
  const hint = word[0] + word.slice(1).replace(/[a-z]/gi, '_');
  document.getElementById('dict-hint').textContent = `æç¤º: ${hint}`;
}

function handleDictKey(e) {
  if (e.key === 'Enter') checkDictation();
}

function checkDictation() {
  const word = dictWords[dictCurrent];
  const input = document.getElementById('dict-input').value.trim().toLowerCase();
  const correct = input === word.toLowerCase();

  const inputEl = document.getElementById('dict-input');
  inputEl.classList.add(correct ? 'correct' : 'wrong');

  dictResults.push({ word, input, correct });

  if (correct) {
    dictScore++;
    document.getElementById('dict-score').textContent = dictScore;
    addPoints(5, '+5 â­ æ‹¼å†™æ­£ç¡®ï¼');
  }

  setTimeout(() => {
    if (!correct) {
      // Show correct word briefly
      inputEl.value = word;
      setTimeout(() => {
        dictCurrent++;
        showDictWord();
      }, 1000);
    } else {
      dictCurrent++;
      showDictWord();
    }
  }, 600);
}

function skipWord() {
  const word = dictWords[dictCurrent];
  dictResults.push({ word, input: '(è·³è¿‡)', correct: false });
  dictCurrent++;
  showDictWord();
}

function showDictResults() {
  document.getElementById('dictation-active').classList.remove('show');
  document.getElementById('dictation-results').classList.add('show');
  document.getElementById('dict-progress').style.width = '100%';

  const pct = Math.round(dictScore/dictTotal*100);
  const emojis = pct === 100 ? 'ğŸŒŸ' : pct >= 80 ? 'ğŸ˜' : pct >= 60 ? 'ğŸ˜Š' : 'ğŸ“š';
  document.getElementById('dict-result-emoji').textContent = emojis;
  document.getElementById('dict-result-score').textContent = `${dictScore}/${dictTotal}`;

  const msgs = [
    'åŠ æ²¹ï¼Œå¤šç»ƒä¹ å°±èƒ½æŒæ¡ï¼Keep practicing!',
    'ä¸é”™ï¼Œç»§ç»­åŠªåŠ›ï¼Good effort!',
    'å¾ˆå¥½ï¼Œè¶Šæ¥è¶Šæ£’ï¼Very good!',
    'å‡ºè‰²ï¼è¯æ±‡é«˜æ‰‹ï¼Excellent speller!'
  ];
  const mi = pct < 50 ? 0 : pct < 70 ? 1 : pct < 90 ? 2 : 3;
  document.getElementById('dict-result-msg').textContent = msgs[mi];

  const breakdown = document.getElementById('dict-breakdown');
  breakdown.innerHTML = dictResults.map(r => `
    <div class="result-item">
      <span class="word">${r.word}</span>
      <span class="answer">${r.input}</span>
      <span class="status">${r.correct ? 'âœ…' : 'âŒ'}</span>
    </div>
  `).join('');

  state.wordsMastered = (state.wordsMastered || 0) + dictScore;
  checkAchievement('first_dictation');
  if (state.wordsMastered >= 20) checkAchievement('words_20');
  saveState();
  updateStats();
}

function resetDictation() {
  document.getElementById('dictation-setup').style.display = 'block';
  document.getElementById('dictation-active').classList.remove('show');
  document.getElementById('dictation-results').classList.remove('show');
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
function buildAchievements() {
  const grid = document.getElementById('achievements-grid');
  grid.innerHTML = ACHIEVEMENTS_DEF.map(a => {
    const earned = state.earnedAchievements?.includes(a.id);
    return `
      <div class="achievement-card ${earned ? 'earned' : 'locked'}">
        <div class="achievement-badge">${earned ? 'âœ¨' : 'ğŸ”’'}</div>
        <span class="achievement-icon">${a.icon}</span>
        <div class="achievement-name">${a.name}</div>
        <div class="achievement-desc">${a.desc}</div>
        ${a.pts > 0 ? `<div class="achievement-pts">+${a.pts} pts</div>` : ''}
      </div>
    `;
  }).join('');
}

function checkAchievement(id) {
  state.earnedAchievements = state.earnedAchievements || [];
  if (state.earnedAchievements.includes(id)) return;

  const def = ACHIEVEMENTS_DEF.find(a => a.id === id);
  if (!def) return;

  state.earnedAchievements.push(id);
  if (def.pts > 0) addPoints(def.pts, `ğŸ… æˆå°±è§£é”ï¼š${def.name} +${def.pts}`);

  // Show notification
  showNotification(`ğŸ… æˆå°±è§£é”ï¼${def.icon} ${def.name}`);
  buildAchievements();
  saveState();
}

function showNotification(msg) {
  const n = document.createElement('div');
  n.style.cssText = `
    position:fixed; top:80px; right:20px; z-index:9999;
    background:linear-gradient(135deg,rgba(26,13,74,0.98),rgba(10,10,26,0.98));
    border:1px solid rgba(245,197,24,0.5);
    border-radius:12px; padding:12px 20px;
    font-family:'Cinzel',serif; font-size:13px; color:var(--gold);
    box-shadow:0 8px 30px rgba(245,197,24,0.3);
    animation:slideIn 0.5s ease, slideOut 0.5s ease 3s forwards;
    max-width:300px;
  `;
  n.textContent = msg;
  document.body.appendChild(n);

  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn { from { opacity:0; transform:translateX(100%); } to { opacity:1; transform:translateX(0); } }
    @keyframes slideOut { from { opacity:1; } to { opacity:0; transform:translateX(100%); } }
  `;
  document.head.appendChild(style);
  setTimeout(() => n.remove(), 3600);
}

// ============================================================
// HOUSE CUP
// ============================================================
function buildHouseCup() {
  const houses = [
    { id:'gryffindor', name:'æ ¼å…°èŠ¬å¤š Gryffindor', icon:'ğŸ¦' },
    { id:'hufflepuff', name:'èµ«å¥‡å¸•å¥‡ Hufflepuff', icon:'ğŸ¦¡' },
    { id:'ravenclaw', name:'æ‹‰æ–‡å…‹åŠ³ Ravenclaw', icon:'ğŸ¦…' },
    { id:'slytherin', name:'æ–¯è±ç‰¹æ— Slytherin', icon:'ğŸ' },
  ];

  const char = CHARACTERS[state.character];
  // Add current user's points to their house
  state.housePoints = state.housePoints || {};
  state.housePoints[char.house] = state.points;

  const max = Math.max(...houses.map(h => state.housePoints[h.id] || 0), 1);

  const barsEl = document.getElementById('house-bars');
  barsEl.innerHTML = houses.map(h => {
    const pts = state.housePoints[h.id] || 0;
    const pct = Math.round(pts/max*100);
    return `
      <div class="house-bar">
        <div class="house-bar-label" style="display:flex;align-items:center;gap:6px">
          ${h.icon} <span style="font-size:12px;">${h.name}</span>
        </div>
        <div class="house-bar-track">
          <div class="house-bar-fill" style="width:${pct}%;background:${HOUSE_COLORS[h.id]}"></div>
        </div>
        <div class="house-bar-pts">${pts}</div>
      </div>
    `;
  }).join('');
}

// ============================================================
// CALENDAR
// ============================================================
function buildCalendar() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();

  document.getElementById('cal-month-title').textContent =
    now.toLocaleDateString('zh-CN', { year:'numeric', month:'long' }) +
    ' Â· ' + now.toLocaleDateString('en-CA', { month:'long', year:'numeric' });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();

  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';

  for (let i = 0; i < firstDay; i++) {
    const d = document.createElement('div');
    d.className = 'cal-day empty';
    grid.appendChild(d);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement('div');
    el.className = 'cal-day';
    el.textContent = d;

    const dayOfYear = Math.floor((new Date(year, month, d) - new Date(year, 0, 0)) / 86400000);
    if (state.completedDays?.includes(dayOfYear % STORIES.length + 1)) {
      el.classList.add('completed');
      el.textContent = 'â­';
    }
    if (d === now.getDate()) el.classList.add('today');
    grid.appendChild(el);
  }
}

// ============================================================
// STATS
// ============================================================
function updateStats() {
  document.getElementById('stat-streak').textContent = state.streak || 0;
  document.getElementById('stat-stories').textContent = state.storiesRead || 0;
  document.getElementById('stat-quizzes').textContent = state.quizzesCompleted || 0;
  document.getElementById('stat-words').textContent = state.wordsMastered || 0;
}

// ============================================================
// POINTS
// ============================================================
function addPoints(amount, label) {
  state.points += amount;
  document.getElementById('total-points').textContent = state.points;

  // Animate
  const pop = document.createElement('div');
  pop.className = 'points-pop';
  pop.textContent = '+' + amount + ' â­';
  pop.style.cssText = `left:${window.innerWidth/2-30}px;top:${window.innerHeight/2}px;`;
  document.body.appendChild(pop);
  setTimeout(() => pop.remove(), 1600);

  // Check point achievements
  if (state.points >= 100) checkAchievement('points_100');
  if (state.points >= 500) checkAchievement('points_500');

  // Update house
  const char = CHARACTERS[state.character];
  if (char) {
    state.housePoints = state.housePoints || {};
    state.housePoints[char.house] = state.points;
    buildHouseCup();
  }
  saveState();
}

// ============================================================
// NAVIGATION
// ============================================================
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  stopSpeech();

  if (name === 'achievements') { buildAchievements(); buildHouseCup(); }
  if (name === 'calendar') { buildCalendar(); updateStats(); }
}

// ============================================================
// START
// ============================================================
window.addEventListener('load', function() {
  try {
    init();
  } catch(e) {
    console.error('Init failed:', e);
    // Emergency fallback: hide loading, show character select
    var ls = document.getElementById('loading-screen');
    if (ls) ls.style.display = 'none';
    var cs = document.getElementById('screen-character');
    if (cs) cs.classList.add('active');
  }
});

// Extra safety: if still loading after 3s, force show character select
setTimeout(function() {
  var ls = document.getElementById('loading-screen');
  if (ls && ls.style.display !== 'none') {
    ls.style.display = 'none';
    var cs = document.getElementById('screen-character');
    if (cs && !document.getElementById('screen-main').classList.contains('active')) {
      cs.classList.add('active');
    }
  }
}, 3000);
</script>
</body>
</html>
